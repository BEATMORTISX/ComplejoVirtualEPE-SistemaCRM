<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complejo Virtual EPE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #f5f5f5;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-color: #bdc3c7;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --header-bg: #1a1a1a;
            
            --gradient-primary: linear-gradient(135deg, #1a1a1a, #2c3e50);
            --gradient-secondary: linear-gradient(135deg, #2c3e50, #34495e);
            --gradient-success: linear-gradient(135deg, #27ae60, #2ecc71);
            --gradient-warning: linear-gradient(135deg, #f39c12, #f1c40f);
            --gradient-danger: linear-gradient(135deg, #e74c3c, #c0392b);
            --gradient-info: linear-gradient(135deg, #3498db, #2980b9);
            
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.2);
            
            --sidebar-width: 280px;
            --header-height: 70px;
            
            --theme-index: 0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* ===== TEMAS ===== */
        body.theme-1 {
            --primary-color: #1a1a1a;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --header-bg: #1a1a1a;
        }
        
        body.theme-2 {
            --primary-color: #1a5276;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --header-bg: #1a5276;
            --gradient-primary: linear-gradient(135deg, #1a5276, #3498db);
        }
        
        body.theme-3 {
            --primary-color: #27ae60;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --header-bg: #27ae60;
            --gradient-primary: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        body.theme-4 {
            --primary-color: #8e44ad;
            --secondary-color: #9b59b6;
            --accent-color: #e74c3c;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --header-bg: #8e44ad;
            --gradient-primary: linear-gradient(135deg, #8e44ad, #9b59b6);
        }
        
        body.dark-mode {
            --primary-color: #1a1a1a;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #2c3e50;
            --dark-color: #ecf0f1;
            --gray-color: #95a5a6;
            --border-color: #34495e;
            --card-bg: #34495e;
            --sidebar-bg: #2c3e50;
            --header-bg: #1a1a1a;
            background: #2c3e50;
            color: #ecf0f1;
        }
        
        body.dark-mode .card {
            background: var(--card-bg);
            color: #ecf0f1;
        }
        
        body.dark-mode .form-control {
            background: #2c3e50;
            color: #ecf0f1;
            border-color: #4a6572;
        }
        
        body.dark-mode table {
            background: var(--card-bg);
            color: #ecf0f1;
        }
        
        body.dark-mode th {
            background: var(--gradient-primary);
            color: white;
        }
        
        body.dark-mode td {
            border-color: #4a6572;
        }
        
        /* ===== BOTONES ===== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn-secondary {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-info {
            background: var(--gradient-info);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        /* ===== LAYOUT GENERAL ===== */
        .hidden {
            display: none !important;
        }
        
        /* ===== LOGIN SCREEN ===== */
        #login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .login-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        .logo-section {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .logo-placeholder {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            position: relative;
            z-index: 1;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .institution-name {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .system-title {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 30px;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        
        .connection-mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .connection-mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .connection-mode-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        /* ===== FORMULARIOS ===== */
        #login-form {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
            color: #333;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            top: 40px;
            color: var(--gray-color);
            z-index: 1;
        }
        
        .password-toggle {
            position: absolute;
            right: 16px;
            top: 40px;
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            z-index: 1;
        }
        
        /* ===== DASHBOARD LAYOUT ===== */
        .dashboard-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .dashboard-header {
            background: var(--header-bg);
            box-shadow: var(--shadow);
            padding: 0 1.5rem;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-mini {
            font-size: 1.8rem;
            color: white;
        }
        
        .header-title h1 {
            margin: 0;
            font-size: 1.5rem;
            color: white;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            border-left: 3px solid var(--accent-color);
            color: white;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: var(--shadow);
        }
        
        .user-details h4 {
            margin: 0;
            font-size: 0.95rem;
        }
        
        .user-details small {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* ===== SIDEBAR ===== */
        .dashboard-content {
            display: flex;
            flex: 1;
        }
        
        .dashboard-nav {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            padding: 1.5rem 0;
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-section {
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        
        .nav-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
            font-weight: 600;
            letter-spacing: 1px;
            padding-left: 10px;
            border-left: 3px solid var(--accent-color);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--radius);
            margin-bottom: 6px;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-color);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: var(--accent-color);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            color: var(--accent-color);
        }
        
        /* ===== CONTENIDO PRINCIPAL ===== */
        .content-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f5f5f5;
        }
        
        .content-section {
            animation: fadeIn 0.5s ease-out;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ===== TARJETAS ===== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 4px solid var(--accent-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-color);
        }
        
        /* ===== TABLAS ===== */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }
        
        th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--light-color);
            vertical-align: middle;
        }
        
        tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: var(--gradient-success);
            color: white;
        }
        
        .badge-warning {
            background: var(--gradient-warning);
            color: white;
        }
        
        .badge-danger {
            background: var(--gradient-danger);
            color: white;
        }
        
        .badge-info {
            background: var(--gradient-info);
            color: white;
        }
        
        /* ===== ESTADÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1.2rem;
            transition: all 0.3s;
            border-top: 4px solid var(--accent-color);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: var(--shadow);
        }
        
        .stat-info h3 {
            margin: 0;
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .stat-info p {
            margin: 0;
            color: var(--gray-color);
            font-size: 1rem;
        }
        
        /* ===== MODALES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.4s ease-out;
        }
        
        .modal-header {
            padding: 1.2rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.2rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* ===== ALERTAS ===== */
        #alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            max-width: 350px;
        }
        
        .alert {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem 1.2rem;
            margin-bottom: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .alert-success {
            border-left-color: var(--success-color);
        }
        
        .alert-error {
            border-left-color: var(--danger-color);
        }
        
        .alert-warning {
            border-left-color: var(--warning-color);
        }
        
        .alert-info {
            border-left-color: var(--info-color);
        }
        
        .alert i {
            font-size: 1.3rem;
        }
        
        /* ===== CONEXIÓN STATUS ===== */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 16px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.4s;
            color: white;
        }
        
        .connection-online {
            background: var(--gradient-success);
        }
        
        .connection-offline {
            background: var(--gradient-danger);
        }
        
        /* ===== BOTÓN GITHUB ===== */
        .github-btn {
            background: linear-gradient(135deg, #333, #555);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .github-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        /* ===== BOTÓN REPARACIÓN ===== */
        .repair-btn {
            background: var(--gradient-danger);
            color: white;
            margin-left: 10px;
        }
        
        /* ===== CARNÉT ===== */
        #carnet-container {
            display: none;
        }
        
        .carnet {
            width: 5.4cm;
            height: 8.6cm;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            margin: 0 auto;
        }
        
        .carnet-header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .carnet-photo {
            width: 80px;
            height: 100px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
        }
        
        .carnet-info {
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .carnet-info p {
            margin: 3px 0;
        }
        
        .carnet-qr {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .dashboard-nav {
                width: 70px;
                padding: 1rem 0;
            }
            
            .nav-title,
            .nav-item span:last-child {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
                padding: 12px;
            }
            
            .header-title h1 {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                padding: 0 1rem;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .card {
                padding: 1.2rem;
            }
            
            .modal-content {
                width: 95%;
            }
        }
        
        /* ===== UTILIDADES ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        
        /* ===== GRID FORMULARIOS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
        }
        
        /* ===== BOTÓN DE VOLVER ===== */
        .back-btn {
            background: var(--gradient-primary);
            color: white;
            margin-bottom: 1.5rem;
        }
        
        /* ===== LOADER ===== */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== APARIENCIA ===== */
        .theme-selector {
            position: relative;
        }
        
        .theme-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius);
            cursor: pointer;
        }
        
        .theme-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 10px;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            z-index: 1000;
            min-width: 200px;
        }
        
        .theme-options.show {
            display: grid;
        }
        
        .theme-option {
            padding: 10px;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .theme-option:hover {
            border-color: var(--accent-color);
        }
        
        .theme-option.theme-1 {
            background: #1a1a1a;
            color: white;
        }
        
        .theme-option.theme-2 {
            background: #1a5276;
            color: white;
        }
        
        .theme-option.theme-3 {
            background: #27ae60;
            color: white;
        }
        
        .theme-option.theme-4 {
            background: #8e44ad;
            color: white;
        }
        
        .theme-option.dark {
            background: #2c3e50;
            color: white;
        }
    </style>
</head>
<body class="theme-1">
    <!-- ===== CONEXIÓN STATUS ===== -->
    <div id="connection-status" class="connection-status connection-offline">
        <i class="fas fa-wifi-slash"></i>
        <span>Modo Offline</span>
    </div>
    
    <!-- ===== ALERTAS ===== -->
    <div id="alert-container"></div>
    
    <!-- ===== CARNÉT ===== -->
    <div id="carnet-container"></div>

    <!-- ===== PANTALLA DE LOGIN ===== -->
    <div id="login-container">
        <div class="login-card">
            <div class="logo-section">
                <div class="logo-placeholder">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="institution-name">Complejo Virtual EPE</h1>
                <div class="system-title">
                    <i class="fas fa-cogs"></i> SISTEMA CRM EDUCATIVO
                </div>
                
                <div class="connection-mode-selector">
                    <div class="connection-mode-btn active" data-mode="online">
                        <i class="fas fa-wifi"></i> Online
                    </div>
                    <div class="connection-mode-btn" data-mode="offline">
                        <i class="fas fa-wifi-slash"></i> Offline
                    </div>
                </div>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user"></i> Usuario/Email
                    </label>
                    <input type="text" id="username" class="form-control" placeholder="Ingrese su usuario o email" required>
                    <div class="input-icon">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i> Contraseña
                    </label>
                    <input type="password" id="password" class="form-control" placeholder="Ingrese su contraseña" required>
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <button type="button" class="password-toggle" id="toggle-password">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesión
                </button>
                <div class="login-footer text-center mt-3">
                    <p><i class="fas fa-shield-alt"></i> Sistema Seguro | Acceso Restringido</p>
                    <p class="version">Versión 4.0.0 | © 2024 Complejo Virtual EPE</p>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== DASHBOARD ADMINISTRADOR ===== -->
    <div id="admin-dashboard" class="dashboard-container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="header-title">
                    <h1>Panel de Administración</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-selector">
                    <button class="theme-btn" id="theme-toggle">
                        <i class="fas fa-palette"></i> Apariencia
                    </button>
                    <div class="theme-options" id="theme-options">
                        <div class="theme-option theme-1" data-theme="theme-1">Negro/Gris</div>
                        <div class="theme-option theme-2" data-theme="theme-2">Azul</div>
                        <div class="theme-option theme-3" data-theme="theme-3">Verde</div>
                        <div class="theme-option theme-4" data-theme="theme-4">Morado</div>
                        <div class="theme-option dark" data-theme="dark">Oscuro</div>
                    </div>
                </div>
                <a href="https://github.com/BEATMORTISX/ComplejoVirtualEPE-SistemaCRM.git" target="_blank" class="github-btn" id="github-btn-admin">
                    <i class="fab fa-github"></i> GitHub
                </a>
                <button id="repair-system-btn" class="btn repair-btn">
                    <i class="fas fa-tools"></i> Reparar
                </button>
                <div class="user-info">
                    <div class="user-avatar" id="admin-avatar">A</div>
                    <div class="user-details">
                        <h4 id="admin-name">Administrador Principal</h4>
                        <small>Administrador</small>
                    </div>
                </div>
                <button id="logout-btn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <nav class="dashboard-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-section="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="mi-perfil">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Gestión</div>
                    <div class="nav-item" data-section="planteles">
                        <i class="fas fa-school"></i>
                        <span>Planteles</span>
                    </div>
                    <div class="nav-item" data-section="directores">
                        <i class="fas fa-user-tie"></i>
                        <span>Directores</span>
                    </div>
                    <div class="nav-item" data-section="docentes">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Docentes</span>
                    </div>
                    <div class="nav-item" data-section="participantes">
                        <i class="fas fa-users"></i>
                        <span>Participantes</span>
                    </div>
                    <div class="nav-item" data-section="formaciones">
                        <i class="fas fa-book-open"></i>
                        <span>Formaciones</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Sistema</div>
                    <div class="nav-item" data-section="usuarios">
                        <i class="fas fa-user-cog"></i>
                        <span>Usuarios</span>
                    </div>
                    <div class="nav-item" data-section="configuracion">
                        <i class="fas fa-cog"></i>
                        <span>Configuración</span>
                    </div>
                    <div class="nav-item" id="sync-now-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Sincronizar</span>
                    </div>
                </div>
            </nav>
            
            <main class="content-area">
                <!-- Dashboard Principal -->
                <div id="section-dashboard" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-primary);">
                                <i class="fas fa-school"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-planteles">0</h3>
                                <p>Planteles</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-secondary);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-participantes">0</h3>
                                <p>Participantes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-warning);">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-docentes">0</h3>
                                <p>Docentes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-danger);">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-formaciones">0</h3>
                                <p>Formaciones</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Acceso Rápido</h3>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="accederInterfaz('plantel')">
                                <i class="fas fa-school"></i> Ver Plantel
                            </button>
                            <button class="btn btn-primary" onclick="accederInterfaz('director')">
                                <i class="fas fa-user-tie"></i> Ver Director
                            </button>
                            <button class="btn btn-primary" onclick="accederInterfaz('docente')">
                                <i class="fas fa-chalkboard-teacher"></i> Ver Docente
                            </button>
                            <button class="btn btn-primary" onclick="accederInterfaz('participante')">
                                <i class="fas fa-user-graduate"></i> Ver Participante
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mi Perfil -->
                <div id="section-mi-perfil" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mi Perfil - Administrador</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input type="text" id="admin-profile-name" class="form-control" value="Administrador Principal">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="admin-profile-email" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Contraseña Actual</label>
                                <input type="password" id="admin-current-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nueva Contraseña</label>
                                <input type="password" id="admin-new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Confirmar Contraseña</label>
                                <input type="password" id="admin-confirm-password" class="form-control">
                            </div>
                        </div>
                        <button class="btn btn-success mt-3" onclick="guardarPerfilAdmin()">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </div>
                
                <!-- Gestión de Planteles -->
                <div id="section-planteles" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Planteles</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-plantel')">
                                <i class="fas fa-plus"></i> Nuevo Plantel
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-planteles">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código Dependencia</th>
                                        <th>Código Plantel</th>
                                        <th>Nombre</th>
                                        <th>Ciudad</th>
                                        <th>Director</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestión de Directores -->
                <div id="section-directores" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Directores</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-director')">
                                <i class="fas fa-plus"></i> Nuevo Director
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-directores">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Plantel</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestión de Docentes -->
                <div id="section-docentes" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Docentes</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-docente')">
                                <i class="fas fa-plus"></i> Nuevo Docente
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-docentes">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Especialidad</th>
                                        <th>Email</th>
                                        <th>Plantel</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestión de Participantes -->
                <div id="section-participantes" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Participantes</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-participante')">
                                <i class="fas fa-plus"></i> Nuevo Participante
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-participantes">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Edad</th>
                                        <th>Email</th>
                                        <th>Formaciones</th>
                                        <th>Plantel</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestión de Formaciones -->
                <div id="section-formaciones" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Formaciones</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-formacion')">
                                <i class="fas fa-plus"></i> Nueva Formación
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-formaciones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Docente</th>
                                        <th>Plantel</th>
                                        <th>Vacantes</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gestión de Usuarios -->
                <div id="section-usuarios" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Gestión de Usuarios</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-usuario')">
                                <i class="fas fa-plus"></i> Nuevo Usuario
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-usuarios">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Nombre</th>
                                        <th>Rol</th>
                                        <th>Email</th>
                                        <th>Entidad</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargan dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Configuración -->
                <div id="section-configuracion" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Configuración del Sistema</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Intervalo de Sincronización (segundos)</label>
                                <input type="number" id="intervalo-sincronizacion" value="5" min="1" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Frecuencia de Backup</label>
                                <select id="frecuencia-backup" class="form-control">
                                    <option value="diario">Diario</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="mensual">Mensual</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-primary" onclick="guardarConfiguracion()">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                            <button class="btn btn-success" onclick="crearBackup()">
                                <i class="fas fa-download"></i> Crear Backup
                            </button>
                            <button class="btn btn-info" onclick="cargarBackup()">
                                <i class="fas fa-upload"></i> Cargar Backup
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Actualizaciones</h3>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="actualizarDesdeGitHub()">
                                <i class="fas fa-sync-alt"></i> Buscar Actualizaciones
                            </button>
                            <button class="btn btn-info" onclick="cargarVersionAnterior()">
                                <i class="fas fa-history"></i> Cargar Versión Anterior
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Reportes</h3>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button class="btn btn-success" onclick="generarReportePDF()">
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                            <button class="btn btn-success" onclick="generarReporteExcel()">
                                <i class="fas fa-file-excel"></i> Generar Excel
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ===== DASHBOARD PLANTEL ===== -->
    <div id="plantel-dashboard" class="dashboard-container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-school"></i>
                </div>
                <div class="header-title">
                    <h1>Panel de Plantel</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-selector">
                    <button class="theme-btn" id="theme-toggle-plantel">
                        <i class="fas fa-palette"></i> Apariencia
                    </button>
                    <div class="theme-options" id="theme-options-plantel">
                        <div class="theme-option theme-1" data-theme="theme-1">Negro/Gris</div>
                        <div class="theme-option theme-2" data-theme="theme-2">Azul</div>
                        <div class="theme-option theme-3" data-theme="theme-3">Verde</div>
                        <div class="theme-option theme-4" data-theme="theme-4">Morado</div>
                        <div class="theme-option dark" data-theme="dark">Oscuro</div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="plantel-avatar">P</div>
                    <div class="user-details">
                        <h4 id="plantel-name">Plantel</h4>
                        <small>Plantel</small>
                    </div>
                </div>
                <button id="logout-btn-plantel" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <nav class="dashboard-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-section="dashboard-plantel">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="mi-perfil-plantel">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Gestión</div>
                    <div class="nav-item" data-section="docentes-plantel">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Docentes</span>
                    </div>
                    <div class="nav-item" data-section="participantes-plantel">
                        <i class="fas fa-users"></i>
                        <span>Participantes</span>
                    </div>
                    <div class="nav-item" data-section="formaciones-plantel">
                        <i class="fas fa-book-open"></i>
                        <span>Formaciones</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Acciones</div>
                    <div class="nav-item" onclick="openModal('modal-docente')">
                        <i class="fas fa-plus"></i>
                        <span>Nuevo Docente</span>
                    </div>
                    <div class="nav-item" onclick="openModal('modal-formacion')">
                        <i class="fas fa-plus"></i>
                        <span>Nueva Formación</span>
                    </div>
                    <div class="nav-item" onclick="openModal('modal-participante')">
                        <i class="fas fa-plus"></i>
                        <span>Nuevo Participante</span>
                    </div>
                </div>
            </nav>
            
            <main class="content-area">
                <!-- Dashboard Plantel -->
                <div id="section-dashboard-plantel" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-secondary);">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-directores-plantel">0</h3>
                                <p>Directores</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-warning);">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-docentes-plantel">0</h3>
                                <p>Docentes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-primary);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-participantes-plantel">0</h3>
                                <p>Participantes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-danger);">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-formaciones-plantel">0</h3>
                                <p>Formaciones</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Información del Plantel</h3>
                        <div id="info-plantel-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Mi Perfil Plantel -->
                <div id="section-mi-perfil-plantel" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mi Perfil - Plantel</h3>
                        </div>
                        <div id="perfil-plantel-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Docentes del Plantel -->
                <div id="section-docentes-plantel" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Docentes del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-docente')">
                                <i class="fas fa-plus"></i> Nuevo Docente
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-docentes-plantel">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Especialidad</th>
                                        <th>Email</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Participantes del Plantel -->
                <div id="section-participantes-plantel" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Participantes del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-participante')">
                                <i class="fas fa-plus"></i> Nuevo Participante
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-participantes-plantel">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Edad</th>
                                        <th>Email</th>
                                        <th>Formaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Formaciones del Plantel -->
                <div id="section-formaciones-plantel" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Formaciones del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-formacion')">
                                <i class="fas fa-plus"></i> Nueva Formación
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-formaciones-plantel">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Docente</th>
                                        <th>Vacantes</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ===== DASHBOARD DIRECTOR ===== -->
    <div id="director-dashboard" class="dashboard-container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="header-title">
                    <h1>Panel de Director</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-selector">
                    <button class="theme-btn" id="theme-toggle-director">
                        <i class="fas fa-palette"></i> Apariencia
                    </button>
                    <div class="theme-options" id="theme-options-director">
                        <div class="theme-option theme-1" data-theme="theme-1">Negro/Gris</div>
                        <div class="theme-option theme-2" data-theme="theme-2">Azul</div>
                        <div class="theme-option theme-3" data-theme="theme-3">Verde</div>
                        <div class="theme-option theme-4" data-theme="theme-4">Morado</div>
                        <div class="theme-option dark" data-theme="dark">Oscuro</div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="director-avatar">D</div>
                    <div class="user-details">
                        <h4 id="director-name">Director</h4>
                        <small>Director</small>
                    </div>
                </div>
                <button id="logout-btn-director" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <nav class="dashboard-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-section="dashboard-director">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="mi-perfil-director">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Gestión</div>
                    <div class="nav-item" data-section="docentes-director">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Docentes</span>
                    </div>
                    <div class="nav-item" data-section="participantes-director">
                        <i class="fas fa-users"></i>
                        <span>Participantes</span>
                    </div>
                    <div class="nav-item" data-section="formaciones-director">
                        <i class="fas fa-book-open"></i>
                        <span>Formaciones</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Acciones</div>
                    <div class="nav-item" onclick="openModal('modal-docente')">
                        <i class="fas fa-plus"></i>
                        <span>Nuevo Docente</span>
                    </div>
                    <div class="nav-item" onclick="openModal('modal-formacion')">
                        <i class="fas fa-plus"></i>
                        <span>Nueva Formación</span>
                    </div>
                    <div class="nav-item" onclick="openModal('modal-participante')">
                        <i class="fas fa-plus"></i>
                        <span>Nuevo Participante</span>
                    </div>
                </div>
            </nav>
            
            <main class="content-area">
                <!-- Dashboard Director -->
                <div id="section-dashboard-director" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-warning);">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-docentes-director">0</h3>
                                <p>Docentes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-primary);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-participantes-director">0</h3>
                                <p>Participantes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-danger);">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-formaciones-director">0</h3>
                                <p>Formaciones</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Información del Director</h3>
                        <div id="info-director-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Mi Perfil Director -->
                <div id="section-mi-perfil-director" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mi Perfil - Director</h3>
                        </div>
                        <div id="perfil-director-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Docentes del Director -->
                <div id="section-docentes-director" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Docentes del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-docente')">
                                <i class="fas fa-plus"></i> Nuevo Docente
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-docentes-director">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Especialidad</th>
                                        <th>Email</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Participantes del Director -->
                <div id="section-participantes-director" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Participantes del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-participante')">
                                <i class="fas fa-plus"></i> Nuevo Participante
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-participantes-director">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Edad</th>
                                        <th>Email</th>
                                        <th>Formaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Formaciones del Director -->
                <div id="section-formaciones-director" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Formaciones del Plantel</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-formacion')">
                                <i class="fas fa-plus"></i> Nueva Formación
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-formaciones-director">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Docente</th>
                                        <th>Vacantes</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ===== DASHBOARD DOCENTE ===== -->
    <div id="docente-dashboard" class="dashboard-container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="header-title">
                    <h1>Panel de Docente</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-selector">
                    <button class="theme-btn" id="theme-toggle-docente">
                        <i class="fas fa-palette"></i> Apariencia
                    </button>
                    <div class="theme-options" id="theme-options-docente">
                        <div class="theme-option theme-1" data-theme="theme-1">Negro/Gris</div>
                        <div class="theme-option theme-2" data-theme="theme-2">Azul</div>
                        <div class="theme-option theme-3" data-theme="theme-3">Verde</div>
                        <div class="theme-option theme-4" data-theme="theme-4">Morado</div>
                        <div class="theme-option dark" data-theme="dark">Oscuro</div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="docente-avatar">D</div>
                    <div class="user-details">
                        <h4 id="docente-name">Docente</h4>
                        <small>Docente</small>
                    </div>
                </div>
                <button id="logout-btn-docente" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <nav class="dashboard-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-section="dashboard-docente">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="mi-perfil-docente">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Gestión</div>
                    <div class="nav-item" data-section="formaciones-docente">
                        <i class="fas fa-book-open"></i>
                        <span>Mis Formaciones</span>
                    </div>
                    <div class="nav-item" data-section="participantes-docente">
                        <i class="fas fa-users"></i>
                        <span>Mis Participantes</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Acciones</div>
                    <div class="nav-item" onclick="openModal('modal-participante')">
                        <i class="fas fa-plus"></i>
                        <span>Añadir Participante</span>
                    </div>
                </div>
            </nav>
            
            <main class="content-area">
                <!-- Dashboard Docente -->
                <div id="section-dashboard-docente" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-danger);">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-formaciones-docente">0</h3>
                                <p>Formaciones</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-primary);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-participantes-docente">0</h3>
                                <p>Participantes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Información del Docente</h3>
                        <div id="info-docente-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Mi Perfil Docente -->
                <div id="section-mi-perfil-docente" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mi Perfil - Docente</h3>
                        </div>
                        <div id="perfil-docente-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Formaciones del Docente -->
                <div id="section-formaciones-docente" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mis Formaciones</h3>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-formaciones-docente">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Vacantes</th>
                                        <th>Participantes</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Participantes del Docente -->
                <div id="section-participantes-docente" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mis Participantes</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-participante')">
                                <i class="fas fa-plus"></i> Añadir Participante
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-participantes-docente">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cédula</th>
                                        <th>Nombre</th>
                                        <th>Edad</th>
                                        <th>Email</th>
                                        <th>Formaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ===== DASHBOARD PARTICIPANTE ===== -->
    <div id="participante-dashboard" class="dashboard-container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="header-title">
                    <h1>Panel de Participante</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-selector">
                    <button class="theme-btn" id="theme-toggle-participante">
                        <i class="fas fa-palette"></i> Apariencia
                    </button>
                    <div class="theme-options" id="theme-options-participante">
                        <div class="theme-option theme-1" data-theme="theme-1">Negro/Gris</div>
                        <div class="theme-option theme-2" data-theme="theme-2">Azul</div>
                        <div class="theme-option theme-3" data-theme="theme-3">Verde</div>
                        <div class="theme-option theme-4" data-theme="theme-4">Morado</div>
                        <div class="theme-option dark" data-theme="dark">Oscuro</div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="participante-avatar">P</div>
                    <div class="user-details">
                        <h4 id="participante-name">Participante</h4>
                        <small>Participante</small>
                    </div>
                </div>
                <button id="logout-btn-participante" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <nav class="dashboard-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <div class="nav-item active" data-section="dashboard-participante">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="mi-perfil-participante">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Formaciones</div>
                    <div class="nav-item" data-section="mis-formaciones">
                        <i class="fas fa-book-open"></i>
                        <span>Mis Formaciones</span>
                    </div>
                    <div class="nav-item" data-section="inscribirse-formacion">
                        <i class="fas fa-pen-alt"></i>
                        <span>Inscribirse a Nueva Formación</span>
                    </div>
                </div>
            </nav>
            
            <main class="content-area">
                <!-- Dashboard Participante -->
                <div id="section-dashboard-participante" class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-danger);">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-mis-formaciones">0</h3>
                                <p>Formaciones Inscritas</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gradient-success);">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-formaciones-disponibles">0</h3>
                                <p>Formaciones Disponibles</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Mi Información</h3>
                        <div id="info-participante-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Mi Perfil Participante -->
                <div id="section-mi-perfil-participante" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mi Perfil - Participante</h3>
                        </div>
                        <div id="perfil-participante-detalle">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Mis Formaciones -->
                <div id="section-mis-formaciones" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Mis Formaciones</h3>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-mis-formaciones">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Docente</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Inscribirse a Formación -->
                <div id="section-inscribirse-formacion" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Inscribirse a Nueva Formación</h3>
                        </div>
                        <div class="form-group mb-3">
                            <label>Plantel</label>
                            <select id="filtro-plantel" class="form-control" onchange="filtrarFormacionesDisponibles()">
                                <option value="">Todos los planteles</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table id="tabla-formaciones-disponibles">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Duración</th>
                                        <th>Modalidad</th>
                                        <th>Docente</th>
                                        <th>Plantel</th>
                                        <th>Vacantes</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ===== MODALES ===== -->
    <!-- Modal para Nuevo Plantel -->
    <div id="modal-plantel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Plantel</h3>
                <button class="close-modal" onclick="closeModal('modal-plantel')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-plantel">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Código de Dependencia *</label>
                            <input type="text" id="plantel-codigo-dependencia" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Código de Plantel *</label>
                            <input type="text" id="plantel-codigo-plantel" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Plantel *</label>
                            <input type="text" id="plantel-nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Dirección *</label>
                            <input type="text" id="plantel-direccion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Ciudad *</label>
                            <input type="text" id="plantel-ciudad" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="plantel-telefono" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="plantel-email" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-plantel')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarPlantel()">Guardar Plantel</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Plantel -->
    <div id="modal-editar-plantel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Plantel</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-plantel')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-plantel">
                    <input type="hidden" id="editar-plantel-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Código de Dependencia *</label>
                            <input type="text" id="editar-plantel-codigo-dependencia" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Código de Plantel *</label>
                            <input type="text" id="editar-plantel-codigo-plantel" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Plantel *</label>
                            <input type="text" id="editar-plantel-nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Dirección *</label>
                            <input type="text" id="editar-plantel-direccion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Ciudad *</label>
                            <input type="text" id="editar-plantel-ciudad" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="editar-plantel-telefono" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editar-plantel-email" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-plantel')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarPlantel()">Actualizar Plantel</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Director -->
    <div id="modal-director" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Director</h3>
                <button class="close-modal" onclick="closeModal('modal-director')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-director">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="director-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="director-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="director-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="director-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="director-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Plantel Asignado *</label>
                            <select id="director-plantel" class="form-control" required>
                                <option value="">Seleccione un plantel</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-director')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarDirector()">Guardar Director</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Director -->
    <div id="modal-editar-director" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Director</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-director')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-director">
                    <input type="hidden" id="editar-director-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="editar-director-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="editar-director-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="editar-director-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="editar-director-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="editar-director-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Plantel Asignado *</label>
                            <select id="editar-director-plantel" class="form-control" required>
                                <option value="">Seleccione un plantel</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-director')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarDirector()">Actualizar Director</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Docente -->
    <div id="modal-docente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Docente</h3>
                <button class="close-modal" onclick="closeModal('modal-docente')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-docente">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="docente-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="docente-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="docente-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Especialidad *</label>
                            <input type="text" id="docente-especialidad" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="docente-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="docente-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="docente-plantel" class="form-control" required>
                                <option value="">Seleccione un plantel</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-docente')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarDocente()">Guardar Docente</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Docente -->
    <div id="modal-editar-docente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Docente</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-docente')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-docente">
                    <input type="hidden" id="editar-docente-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="editar-docente-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="editar-docente-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="editar-docente-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Especialidad *</label>
                            <input type="text" id="editar-docente-especialidad" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="editar-docente-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="editar-docente-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="editar-docente-plantel" class="form-control" required>
                                <option value="">Seleccione un plantel</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-docente')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarDocente()">Actualizar Docente</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Participante -->
    <div id="modal-participante" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Participante</h3>
                <button class="close-modal" onclick="closeModal('modal-participante')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-participante">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="participante-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="participante-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="participante-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="participante-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Correo Electrónico *</label>
                            <input type="email" id="participante-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Edad *</label>
                            <input type="number" id="participante-edad" class="form-control" required min="16">
                        </div>
                        <div class="form-group">
                            <label>Sexo *</label>
                            <select id="participante-sexo" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="participante-fecha-nacimiento" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Lugar de Nacimiento *</label>
                            <input type="text" id="participante-lugar-nacimiento" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Parroquia donde vive *</label>
                            <input type="text" id="participante-parroquia" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Dirección de Habitación *</label>
                            <input type="text" id="participante-direccion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>¿Posée alguna discapacidad? *</label>
                            <select id="participante-discapacidad" class="form-control" required onchange="toggleDiscapacidad()">
                                <option value="">Seleccionar</option>
                                <option value="no">No</option>
                                <option value="si">Sí</option>
                            </select>
                        </div>
                        <div class="form-group" id="discapacidad-detalle" style="display: none;">
                            <label>Indicar Discapacidad</label>
                            <input type="text" id="participante-discapacidad-detalle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Talla de Camisa</label>
                            <input type="text" id="participante-talla-camisa" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="participante-peso" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label>Talla de Pantalón</label>
                            <input type="text" id="participante-talla-pantalon" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Talla de Zapato</label>
                            <input type="number" id="participante-talla-zapato" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label>Ocupación Actual</label>
                            <input type="text" id="participante-ocupacion" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Grado de Instrucción *</label>
                            <select id="participante-grado-instruccion" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="primaria">Primaria</option>
                                <option value="bachiller">Bachiller</option>
                                <option value="tecnico">Técnico</option>
                                <option value="universitario">Universitario</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="participante-plantel" class="form-control" required onchange="cargarDocentesYFormaciones()">
                                <option value="">Seleccionar Plantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Docente *</label>
                            <select id="participante-docente" class="form-control" required onchange="cargarFormacionesPorDocente()">
                                <option value="">Seleccionar Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Formación a Inscribir *</label>
                            <select id="participante-formacion" class="form-control" required>
                                <option value="">Seleccionar Formación</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-participante')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarParticipante()">Guardar Participante</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Participante -->
    <div id="modal-editar-participante" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Participante</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-participante')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-participante">
                    <input type="hidden" id="editar-participante-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombres *</label>
                            <input type="text" id="editar-participante-nombres" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" id="editar-participante-apellidos" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Cédula *</label>
                            <input type="text" id="editar-participante-cedula" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono *</label>
                            <input type="tel" id="editar-participante-telefono" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Correo Electrónico *</label>
                            <input type="email" id="editar-participante-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Edad *</label>
                            <input type="number" id="editar-participante-edad" class="form-control" required min="16">
                        </div>
                        <div class="form-group">
                            <label>Sexo *</label>
                            <select id="editar-participante-sexo" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="editar-participante-fecha-nacimiento" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Lugar de Nacimiento *</label>
                            <input type="text" id="editar-participante-lugar-nacimiento" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Parroquia donde vive *</label>
                            <input type="text" id="editar-participante-parroquia" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Dirección de Habitación *</label>
                            <input type="text" id="editar-participante-direccion" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>¿Posée alguna discapacidad? *</label>
                            <select id="editar-participante-discapacidad" class="form-control" required onchange="toggleDiscapacidadEditar()">
                                <option value="">Seleccionar</option>
                                <option value="no">No</option>
                                <option value="si">Sí</option>
                            </select>
                        </div>
                        <div class="form-group" id="editar-discapacidad-detalle" style="display: none;">
                            <label>Indicar Discapacidad</label>
                            <input type="text" id="editar-participante-discapacidad-detalle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Talla de Camisa</label>
                            <input type="text" id="editar-participante-talla-camisa" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="editar-participante-peso" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label>Talla de Pantalón</label>
                            <input type="text" id="editar-participante-talla-pantalon" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Talla de Zapato</label>
                            <input type="number" id="editar-participante-talla-zapato" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label>Ocupación Actual</label>
                            <input type="text" id="editar-participante-ocupacion" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Grado de Instrucción *</label>
                            <select id="editar-participante-grado-instruccion" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="primaria">Primaria</option>
                                <option value="bachiller">Bachiller</option>
                                <option value="tecnico">Técnico</option>
                                <option value="universitario">Universitario</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="editar-participante-plantel" class="form-control" required onchange="cargarDocentesYFormacionesEditar()">
                                <option value="">Seleccionar Plantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Docente *</label>
                            <select id="editar-participante-docente" class="form-control" required onchange="cargarFormacionesPorDocenteEditar()">
                                <option value="">Seleccionar Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Formación a Inscribir *</label>
                            <select id="editar-participante-formacion" class="form-control" required>
                                <option value="">Seleccionar Formación</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-participante')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarParticipante()">Actualizar Participante</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Formación -->
    <div id="modal-formacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Formación</h3>
                <button class="close-modal" onclick="closeModal('modal-formacion')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-formacion">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Código *</label>
                            <input type="text" id="formacion-codigo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="formacion-nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea id="formacion-descripcion" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Duración (horas) *</label>
                            <input type="number" id="formacion-duracion" class="form-control" required min="1">
                        </div>
                        <div class="form-group">
                            <label>Modalidad *</label>
                            <select id="formacion-modalidad" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="presencial">Presencial</option>
                                <option value="virtual">Virtual</option>
                                <option value="mixta">Mixta</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="formacion-plantel" class="form-control" required onchange="cargarDocentesPorPlantel()">
                                <option value="">Seleccionar Plantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Docente *</label>
                            <select id="formacion-docente" class="form-control" required>
                                <option value="">Seleccionar Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio *</label>
                            <input type="date" id="formacion-fecha-inicio" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin *</label>
                            <input type="date" id="formacion-fecha-fin" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Vacantes *</label>
                            <input type="number" id="formacion-vacantes" class="form-control" required min="1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-formacion')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarFormacion()">Guardar Formación</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Formación -->
    <div id="modal-editar-formacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Formación</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-formacion')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-formacion">
                    <input type="hidden" id="editar-formacion-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Código *</label>
                            <input type="text" id="editar-formacion-codigo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="editar-formacion-nombre" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea id="editar-formacion-descripcion" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Duración (horas) *</label>
                            <input type="number" id="editar-formacion-duracion" class="form-control" required min="1">
                        </div>
                        <div class="form-group">
                            <label>Modalidad *</label>
                            <select id="editar-formacion-modalidad" class="form-control" required>
                                <option value="">Seleccionar</option>
                                <option value="presencial">Presencial</option>
                                <option value="virtual">Virtual</option>
                                <option value="mixta">Mixta</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Plantel *</label>
                            <select id="editar-formacion-plantel" class="form-control" required onchange="cargarDocentesPorPlantelEditar()">
                                <option value="">Seleccionar Plantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Docente *</label>
                            <select id="editar-formacion-docente" class="form-control" required>
                                <option value="">Seleccionar Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio *</label>
                            <input type="date" id="editar-formacion-fecha-inicio" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin *</label>
                            <input type="date" id="editar-formacion-fecha-fin" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Vacantes *</label>
                            <input type="number" id="editar-formacion-vacantes" class="form-control" required min="1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-formacion')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarFormacion()">Actualizar Formación</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Usuario -->
    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Usuario</h3>
                <button class="close-modal" onclick="closeModal('modal-usuario')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-usuario">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Seleccionar Plantel *</label>
                            <select id="usuario-plantel" class="form-control" required onchange="cargarEntidadesPorPlantel()">
                                <option value="">Seleccionar Plantel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Seleccionar Rol *</label>
                            <select id="usuario-rol" class="form-control" required onchange="actualizarUsuarioSegunRol()">
                                <option value="">Seleccionar Rol</option>
                                <option value="plantel">Plantel</option>
                                <option value="director">Director</option>
                                <option value="docente">Docente</option>
                                <option value="participante">Participante</option>
                            </select>
                        </div>
                        <div class="form-group" id="usuario-entidad-container" style="display: none;">
                            <label id="usuario-entidad-label">Seleccionar</label>
                            <select id="usuario-entidad" class="form-control">
                                <!-- Se llena dinámicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Usuario *</label>
                            <input type="text" id="usuario-username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Contraseña *</label>
                            <input type="password" id="usuario-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Confirmar Contraseña *</label>
                            <input type="password" id="usuario-confirm-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="usuario-email" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-usuario')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarUsuario()">Guardar Usuario</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Usuario -->
    <div id="modal-editar-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Usuario</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-usuario')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-usuario">
                    <input type="hidden" id="editar-usuario-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Usuario *</label>
                            <input type="text" id="editar-usuario-username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Contraseña (dejar en blanco para no cambiar)</label>
                            <input type="password" id="editar-usuario-password" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Confirmar Contraseña</label>
                            <input type="password" id="editar-usuario-confirm-password" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editar-usuario-email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Estado *</label>
                            <select id="editar-usuario-estado" class="form-control" required>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-editar-usuario')">Cancelar</button>
                <button class="btn btn-primary" onclick="actualizarUsuario()">Actualizar Usuario</button>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA COMPLETO =====
        let datosSistema = {
            planteles: [],
            directores: [],
            docentes: [],
            participantes: [],
            formaciones: [],
            usuarios: [],
            configuracion: {
                intervaloSincronizacion: 5,
                frecuenciaBackup: 'diario',
                modoConexion: 'online',
                tema: 'theme-1'
            }
        };

        let currentUser = null;
        let currentRole = null;
        let intervaloSincronizacion = null;
        let modoConexion = 'online';
        let editandoId = null;
        let ultimoBackup = null;

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            inicializarEventos();
            configurarModoConexion();
            cargarTemaGuardado();
        });

        function cargarDatos() {
            const datosGuardados = localStorage.getItem('complejoVirtualEPE');
            if (datosGuardados) {
                datosSistema = JSON.parse(datosGuardados);
            } else {
                // Crear usuario administrador inicial
                datosSistema.usuarios = [{
                    id: generarCodigoUnico(),
                    username: 'pabloemiliorico24@gmail.com',
                    password: 'Perp.241',
                    email: 'pabloemiliorico24@gmail.com',
                    nombre: 'Administrador Principal',
                    rol: 'admin',
                    entidadId: null,
                    estado: 'activo',
                    ultimoAcceso: null
                }];
                guardarDatos();
            }
            actualizarEstadisticas();
        }

        function guardarDatos() {
            localStorage.setItem('complejoVirtualEPE', JSON.stringify(datosSistema));
            // Crear backup automático
            crearBackupAutomatico();
        }

        function generarCodigoUnico() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ===== EVENTOS =====
        function inicializarEventos() {
            // Login
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Toggle password
            document.getElementById('toggle-password').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const icon = this.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            });

            // Modo conexión
            document.querySelectorAll('.connection-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.connection-mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    modoConexion = this.dataset.mode;
                    configurarModoConexion();
                });
            });

            // Logout
            document.querySelectorAll('[id^="logout-btn"]').forEach(btn => {
                btn.addEventListener('click', logout);
            });

            // Sincronizar
            document.getElementById('sync-now-btn')?.addEventListener('click', sincronizarDatos);

            // Reparar sistema
            document.getElementById('repair-system-btn')?.addEventListener('click', repararSistema);

            // Navegación
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });

            // Temas
            document.querySelectorAll('#theme-toggle, #theme-toggle-plantel, #theme-toggle-director, #theme-toggle-docente, #theme-toggle-participante').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const optionsId = this.id.replace('toggle', 'options');
                    const options = document.getElementById(optionsId);
                    options.classList.toggle('show');
                });
            });

            // Cerrar temas al hacer clic fuera
            document.addEventListener('click', function() {
                document.querySelectorAll('.theme-options').forEach(options => {
                    options.classList.remove('show');
                });
            });

            // Seleccionar tema
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const theme = this.dataset.theme;
                    cambiarTema(theme);
                    document.querySelectorAll('.theme-options').forEach(options => {
                        options.classList.remove('show');
                    });
                });
            });
        }

        // ===== TEMAS =====
        function cambiarTema(theme) {
            document.body.className = theme;
            datosSistema.configuracion.tema = theme;
            guardarDatos();
        }

        function cargarTemaGuardado() {
            if (datosSistema.configuracion.tema) {
                document.body.className = datosSistema.configuracion.tema;
            }
        }

        // ===== LOGIN =====
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showAlert('Por favor, complete todos los campos', 'error');
                return;
            }

            const usuario = datosSistema.usuarios.find(u => 
                (u.username === username || u.email === username) && 
                u.password === password && 
                u.estado === 'activo'
            );

            if (!usuario) {
                showAlert('Credenciales incorrectas o usuario inactivo', 'error');
                return;
            }

            // Actualizar último acceso
            usuario.ultimoAcceso = new Date().toISOString();
            guardarDatos();

            // Iniciar sesión
            currentUser = usuario;
            currentRole = usuario.rol;

            // Mostrar dashboard correspondiente
            mostrarDashboard(usuario.rol, usuario);

            showAlert(`¡Bienvenido, ${usuario.nombre}!`, 'success');
        }

        function mostrarDashboard(role, usuario) {
            // Ocultar login
            document.getElementById('login-container').classList.add('hidden');

            // Mostrar dashboard correspondiente
            const dashboardId = `${role}-dashboard`;
            document.getElementById(dashboardId).classList.remove('hidden');

            // Configurar interfaz
            configurarInterfaz(role, usuario);

            // Iniciar sincronización automática
            iniciarSincronizacionAutomatica();
        }

        function configurarInterfaz(role, usuario) {
            switch(role) {
                case 'admin':
                    document.getElementById('admin-name').textContent = usuario.nombre;
                    document.getElementById('admin-avatar').textContent = usuario.nombre.charAt(0);
                    cargarSeccionAdmin('dashboard');
                    break;
                case 'plantel':
                    document.getElementById('plantel-name').textContent = usuario.nombre;
                    document.getElementById('plantel-avatar').textContent = usuario.nombre.charAt(0);
                    cargarSeccionPlantel('dashboard-plantel');
                    break;
                case 'director':
                    document.getElementById('director-name').textContent = usuario.nombre;
                    document.getElementById('director-avatar').textContent = usuario.nombre.charAt(0);
                    cargarSeccionDirector('dashboard-director');
                    break;
                case 'docente':
                    document.getElementById('docente-name').textContent = usuario.nombre;
                    document.getElementById('docente-avatar').textContent = usuario.nombre.charAt(0);
                    cargarSeccionDocente('dashboard-docente');
                    break;
                case 'participante':
                    document.getElementById('participante-name').textContent = usuario.nombre;
                    document.getElementById('participante-avatar').textContent = usuario.nombre.charAt(0);
                    cargarSeccionParticipante('dashboard-participante');
                    break;
            }
        }

        // ===== NAVEGACIÓN =====
        function switchSection(sectionId) {
            // Actualizar navegación activa
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.querySelector(`[data-section="${sectionId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Mostrar sección seleccionada
            const seccion = document.getElementById(`section-${sectionId}`);
            if (seccion) {
                seccion.classList.remove('hidden');
            }

            // Cargar datos de la sección
            if (currentRole === 'admin') {
                cargarSeccionAdmin(sectionId);
            } else if (currentRole === 'plantel') {
                cargarSeccionPlantel(sectionId);
            } else if (currentRole === 'director') {
                cargarSeccionDirector(sectionId);
            } else if (currentRole === 'docente') {
                cargarSeccionDocente(sectionId);
            } else if (currentRole === 'participante') {
                cargarSeccionParticipante(sectionId);
            }
        }

        // ===== SECCIONES ADMIN =====
        function cargarSeccionAdmin(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    actualizarEstadisticas();
                    break;
                case 'planteles':
                    cargarPlanteles();
                    break;
                case 'directores':
                    cargarDirectores();
                    break;
                case 'docentes':
                    cargarDocentes();
                    break;
                case 'participantes':
                    cargarParticipantes();
                    break;
                case 'formaciones':
                    cargarFormaciones();
                    break;
                case 'usuarios':
                    cargarUsuarios();
                    break;
                case 'mi-perfil':
                    cargarPerfilAdmin();
                    break;
            }
        }

        function cargarPlanteles() {
            const tbody = document.querySelector('#tabla-planteles tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.planteles.forEach(plantel => {
                const director = datosSistema.directores.find(d => d.plantelId === plantel.id);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${plantel.id.substring(0, 8)}</td>
                    <td>${plantel.codigoDependencia}</td>
                    <td>${plantel.codigoPlantel}</td>
                    <td>${plantel.nombre}</td>
                    <td>${plantel.ciudad}</td>
                    <td>${director ? `${director.nombres} ${director.apellidos}` : 'No asignado'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarPlantel('${plantel.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="accederInterfazPlantel('${plantel.id}')">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarPlantel('${plantel.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarDirectores() {
            const tbody = document.querySelector('#tabla-directores tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.directores.forEach(director => {
                const plantel = datosSistema.planteles.find(p => p.id === director.plantelId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${director.id.substring(0, 8)}</td>
                    <td>${director.cedula}</td>
                    <td>${director.nombres} ${director.apellidos}</td>
                    <td>${director.email}</td>
                    <td>${director.telefono}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarDirector('${director.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarDirector('${director.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarDocentes() {
            const tbody = document.querySelector('#tabla-docentes tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.docentes.forEach(docente => {
                const plantel = datosSistema.planteles.find(p => p.id === docente.plantelId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${docente.id.substring(0, 8)}</td>
                    <td>${docente.cedula}</td>
                    <td>${docente.nombres} ${docente.apellidos}</td>
                    <td>${docente.especialidad}</td>
                    <td>${docente.email}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarDocente('${docente.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarDocente('${docente.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarParticipantes() {
            const tbody = document.querySelector('#tabla-participantes tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.participantes.forEach(participante => {
                const formacionesIds = participante.formacionesIds || [];
                const formacionesNombres = formacionesIds.map(id => {
                    const formacion = datosSistema.formaciones.find(f => f.id === id);
                    return formacion ? formacion.nombre : '';
                }).filter(nombre => nombre).join(', ') || 'Ninguna';
                
                const plantel = datosSistema.planteles.find(p => p.id === participante.plantelId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${participante.id.substring(0, 8)}</td>
                    <td>${participante.cedula}</td>
                    <td>${participante.nombres} ${participante.apellidos}</td>
                    <td>${participante.edad}</td>
                    <td>${participante.email}</td>
                    <td>${formacionesNombres}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarParticipante('${participante.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="generarCarnet('${participante.id}')">
                            <i class="fas fa-id-card"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarParticipante('${participante.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarFormaciones() {
            const tbody = document.querySelector('#tabla-formaciones tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.formaciones.forEach(formacion => {
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const plantel = datosSistema.planteles.find(p => p.id === formacion.plantelId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>${formacion.vacantes}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarFormacion('${formacion.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarFormacion('${formacion.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarUsuarios() {
            const tbody = document.querySelector('#tabla-usuarios tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            datosSistema.usuarios.forEach(usuario => {
                if (usuario.id === currentUser.id) return; // No mostrar al usuario actual
                
                let entidadNombre = 'N/A';
                if (usuario.entidadId) {
                    switch(usuario.rol) {
                        case 'plantel':
                            const plantel = datosSistema.planteles.find(p => p.id === usuario.entidadId);
                            entidadNombre = plantel ? plantel.nombre : 'N/A';
                            break;
                        case 'director':
                            const director = datosSistema.directores.find(d => d.id === usuario.entidadId);
                            entidadNombre = director ? `${director.nombres} ${director.apellidos}` : 'N/A';
                            break;
                        case 'docente':
                            const docente = datosSistema.docentes.find(d => d.id === usuario.entidadId);
                            entidadNombre = docente ? `${docente.nombres} ${docente.apellidos}` : 'N/A';
                            break;
                        case 'participante':
                            const participante = datosSistema.participantes.find(p => p.id === usuario.entidadId);
                            entidadNombre = participante ? `${participante.nombres} ${participante.apellidos}` : 'N/A';
                            break;
                    }
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${usuario.id.substring(0, 8)}</td>
                    <td>${usuario.username}</td>
                    <td>${usuario.nombre}</td>
                    <td><span class="badge badge-info">${usuario.rol}</span></td>
                    <td>${usuario.email || 'N/A'}</td>
                    <td>${entidadNombre}</td>
                    <td><span class="badge ${usuario.estado === 'activo' ? 'badge-success' : 'badge-danger'}">${usuario.estado}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarUsuario('${usuario.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${usuario.rol !== 'admin' ? `
                            <button class="btn btn-sm btn-danger" onclick="eliminarUsuario('${usuario.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== SECCIONES PLANTEL =====
        function cargarSeccionPlantel(sectionId) {
            const plantelId = currentUser.entidadId;
            const plantel = datosSistema.planteles.find(p => p.id === plantelId);

            if (!plantel) {
                showAlert('Plantel no encontrado', 'error');
                return;
            }

            switch(sectionId) {
                case 'dashboard-plantel':
                    cargarEstadisticasPlantel(plantelId);
                    cargarInfoPlantel(plantel);
                    break;
                case 'mi-perfil-plantel':
                    cargarPerfilPlantel(plantel);
                    break;
                case 'docentes-plantel':
                    cargarDocentesPlantel(plantelId);
                    break;
                case 'participantes-plantel':
                    cargarParticipantesPlantel(plantelId);
                    break;
                case 'formaciones-plantel':
                    cargarFormacionesPlantel(plantelId);
                    break;
            }
        }

        function cargarEstadisticasPlantel(plantelId) {
            const directores = datosSistema.directores.filter(d => d.plantelId === plantelId).length;
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId).length;
            const participantes = datosSistema.participantes.filter(p => p.plantelId === plantelId).length;
            const formaciones = datosSistema.formaciones.filter(f => f.plantelId === plantelId).length;

            document.getElementById('stat-directores-plantel').textContent = directores;
            document.getElementById('stat-docentes-plantel').textContent = docentes;
            document.getElementById('stat-participantes-plantel').textContent = participantes;
            document.getElementById('stat-formaciones-plantel').textContent = formaciones;
        }

        function cargarInfoPlantel(plantel) {
            const director = datosSistema.directores.find(d => d.plantelId === plantel.id);
            const infoDiv = document.getElementById('info-plantel-detalle');
            infoDiv.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Código Dependencia</label>
                        <input type="text" class="form-control" value="${plantel.codigoDependencia}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Código Plantel</label>
                        <input type="text" class="form-control" value="${plantel.codigoPlantel}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" class="form-control" value="${plantel.nombre}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <input type="text" class="form-control" value="${plantel.direccion}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" class="form-control" value="${plantel.ciudad}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" value="${plantel.telefono || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${plantel.email || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Director</label>
                        <input type="text" class="form-control" value="${director ? `${director.nombres} ${director.apellidos}` : 'No asignado'}" readonly>
                    </div>
                </div>
            `;
        }

        function cargarPerfilPlantel(plantel) {
            const director = datosSistema.directores.find(d => d.plantelId === plantel.id);
            const div = document.getElementById('perfil-plantel-detalle');
            div.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Código Dependencia</label>
                        <input type="text" class="form-control" value="${plantel.codigoDependencia}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Código Plantel</label>
                        <input type="text" class="form-control" value="${plantel.codigoPlantel}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" class="form-control" value="${plantel.nombre}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <input type="text" class="form-control" value="${plantel.direccion}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" class="form-control" value="${plantel.ciudad}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" value="${plantel.telefono || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${plantel.email || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Director</label>
                        <input type="text" class="form-control" value="${director ? `${director.nombres} ${director.apellidos}` : 'No asignado'}" readonly>
                    </div>
                </div>
            `;
        }

        function cargarDocentesPlantel(plantelId) {
            const tbody = document.querySelector('#tabla-docentes-plantel tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${docente.id.substring(0, 8)}</td>
                    <td>${docente.cedula}</td>
                    <td>${docente.nombres} ${docente.apellidos}</td>
                    <td>${docente.especialidad}</td>
                    <td>${docente.email}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarDocente('${docente.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarDocente('${docente.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarParticipantesPlantel(plantelId) {
            const tbody = document.querySelector('#tabla-participantes-plantel tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const participantes = datosSistema.participantes.filter(p => p.plantelId === plantelId);
            participantes.forEach(participante => {
                const formacionesIds = participante.formacionesIds || [];
                const formacionesNombres = formacionesIds.map(id => {
                    const formacion = datosSistema.formaciones.find(f => f.id === id);
                    return formacion ? formacion.nombre : '';
                }).filter(nombre => nombre).join(', ') || 'Ninguna';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${participante.id.substring(0, 8)}</td>
                    <td>${participante.cedula}</td>
                    <td>${participante.nombres} ${participante.apellidos}</td>
                    <td>${participante.edad}</td>
                    <td>${participante.email}</td>
                    <td>${formacionesNombres}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarParticipante('${participante.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="generarCarnet('${participante.id}')">
                            <i class="fas fa-id-card"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarParticipante('${participante.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarFormacionesPlantel(plantelId) {
            const tbody = document.querySelector('#tabla-formaciones-plantel tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const formaciones = datosSistema.formaciones.filter(f => f.plantelId === plantelId);
            formaciones.forEach(formacion => {
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td>${formacion.vacantes}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarFormacion('${formacion.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarFormacion('${formacion.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== SECCIONES DIRECTOR =====
        function cargarSeccionDirector(sectionId) {
            const directorId = currentUser.entidadId;
            const director = datosSistema.directores.find(d => d.id === directorId);

            if (!director) {
                showAlert('Director no encontrado', 'error');
                return;
            }

            const plantelId = director.plantelId;

            switch(sectionId) {
                case 'dashboard-director':
                    cargarEstadisticasDirector(plantelId);
                    cargarInfoDirector(director);
                    break;
                case 'mi-perfil-director':
                    cargarPerfilDirector(director);
                    break;
                case 'docentes-director':
                    cargarDocentesDirector(plantelId);
                    break;
                case 'participantes-director':
                    cargarParticipantesDirector(plantelId);
                    break;
                case 'formaciones-director':
                    cargarFormacionesDirector(plantelId);
                    break;
            }
        }

        function cargarEstadisticasDirector(plantelId) {
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId).length;
            const participantes = datosSistema.participantes.filter(p => p.plantelId === plantelId).length;
            const formaciones = datosSistema.formaciones.filter(f => f.plantelId === plantelId).length;

            document.getElementById('stat-docentes-director').textContent = docentes;
            document.getElementById('stat-participantes-director').textContent = participantes;
            document.getElementById('stat-formaciones-director').textContent = formaciones;
        }

        function cargarInfoDirector(director) {
            const plantel = datosSistema.planteles.find(p => p.id === director.plantelId);
            const infoDiv = document.getElementById('info-director-detalle');
            infoDiv.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cédula</label>
                        <input type="text" class="form-control" value="${director.cedula}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombres</label>
                        <input type="text" class="form-control" value="${director.nombres}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Apellidos</label>
                        <input type="text" class="form-control" value="${director.apellidos}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" value="${director.telefono}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${director.email}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Plantel</label>
                        <input type="text" class="form-control" value="${plantel ? plantel.nombre : 'No asignado'}" readonly>
                    </div>
                </div>
            `;
        }

        function cargarPerfilDirector(director) {
            const plantel = datosSistema.planteles.find(p => p.id === director.plantelId);
            const div = document.getElementById('perfil-director-detalle');
            div.innerHTML = cargarInfoDirector(director).innerHTML;
        }

        function cargarDocentesDirector(plantelId) {
            const tbody = document.querySelector('#tabla-docentes-director tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${docente.id.substring(0, 8)}</td>
                    <td>${docente.cedula}</td>
                    <td>${docente.nombres} ${docente.apellidos}</td>
                    <td>${docente.especialidad}</td>
                    <td>${docente.email}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarDocente('${docente.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarDocente('${docente.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarParticipantesDirector(plantelId) {
            const tbody = document.querySelector('#tabla-participantes-director tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const participantes = datosSistema.participantes.filter(p => p.plantelId === plantelId);
            participantes.forEach(participante => {
                const formacionesIds = participante.formacionesIds || [];
                const formacionesNombres = formacionesIds.map(id => {
                    const formacion = datosSistema.formaciones.find(f => f.id === id);
                    return formacion ? formacion.nombre : '';
                }).filter(nombre => nombre).join(', ') || 'Ninguna';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${participante.id.substring(0, 8)}</td>
                    <td>${participante.cedula}</td>
                    <td>${participante.nombres} ${participante.apellidos}</td>
                    <td>${participante.edad}</td>
                    <td>${participante.email}</td>
                    <td>${formacionesNombres}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarParticipante('${participante.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="generarCarnet('${participante.id}')">
                            <i class="fas fa-id-card"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarParticipante('${participante.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarFormacionesDirector(plantelId) {
            const tbody = document.querySelector('#tabla-formaciones-director tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const formaciones = datosSistema.formaciones.filter(f => f.plantelId === plantelId);
            formaciones.forEach(formacion => {
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td>${formacion.vacantes}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarFormacion('${formacion.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarFormacion('${formacion.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== SECCIONES DOCENTE =====
        function cargarSeccionDocente(sectionId) {
            const docenteId = currentUser.entidadId;
            const docente = datosSistema.docentes.find(d => d.id === docenteId);

            if (!docente) {
                showAlert('Docente no encontrado', 'error');
                return;
            }

            switch(sectionId) {
                case 'dashboard-docente':
                    cargarEstadisticasDocente(docenteId);
                    cargarInfoDocente(docente);
                    break;
                case 'mi-perfil-docente':
                    cargarPerfilDocente(docente);
                    break;
                case 'formaciones-docente':
                    cargarFormacionesDocente(docenteId);
                    break;
                case 'participantes-docente':
                    cargarParticipantesDocente(docenteId);
                    break;
            }
        }

        function cargarEstadisticasDocente(docenteId) {
            const formaciones = datosSistema.formaciones.filter(f => f.docenteId === docenteId).length;
            const participantes = datosSistema.participantes.filter(p => 
                (p.formacionesIds || []).some(formacionId => {
                    const formacion = datosSistema.formaciones.find(f => f.id === formacionId);
                    return formacion && formacion.docenteId === docenteId;
                })
            ).length;

            document.getElementById('stat-formaciones-docente').textContent = formaciones;
            document.getElementById('stat-participantes-docente').textContent = participantes;
        }

        function cargarInfoDocente(docente) {
            const plantel = datosSistema.planteles.find(p => p.id === docente.plantelId);
            const infoDiv = document.getElementById('info-docente-detalle');
            infoDiv.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cédula</label>
                        <input type="text" class="form-control" value="${docente.cedula}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombres</label>
                        <input type="text" class="form-control" value="${docente.nombres}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Apellidos</label>
                        <input type="text" class="form-control" value="${docente.apellidos}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Especialidad</label>
                        <input type="text" class="form-control" value="${docente.especialidad}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" value="${docente.telefono}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${docente.email}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Plantel</label>
                        <input type="text" class="form-control" value="${plantel ? plantel.nombre : 'No asignado'}" readonly>
                    </div>
                </div>
            `;
        }

        function cargarPerfilDocente(docente) {
            const div = document.getElementById('perfil-docente-detalle');
            div.innerHTML = cargarInfoDocente(docente).innerHTML;
        }

        function cargarFormacionesDocente(docenteId) {
            const tbody = document.querySelector('#tabla-formaciones-docente tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const formaciones = datosSistema.formaciones.filter(f => f.docenteId === docenteId);
            formaciones.forEach(formacion => {
                const participantes = datosSistema.participantes.filter(p => 
                    (p.formacionesIds || []).includes(formacion.id)
                ).length;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${formacion.vacantes}</td>
                    <td>${participantes}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarFormacion('${formacion.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarParticipantesDocente(docenteId) {
            const tbody = document.querySelector('#tabla-participantes-docente tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const formacionesDocente = datosSistema.formaciones.filter(f => f.docenteId === docenteId);
            const formacionesIds = formacionesDocente.map(f => f.id);
            
            const participantes = datosSistema.participantes.filter(p => 
                (p.formacionesIds || []).some(id => formacionesIds.includes(id))
            );
            
            participantes.forEach(participante => {
                const formacionesParticipante = (participante.formacionesIds || [])
                    .filter(id => formacionesIds.includes(id))
                    .map(id => {
                        const formacion = datosSistema.formaciones.find(f => f.id === id);
                        return formacion ? formacion.nombre : '';
                    })
                    .filter(nombre => nombre)
                    .join(', ');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${participante.id.substring(0, 8)}</td>
                    <td>${participante.cedula}</td>
                    <td>${participante.nombres} ${participante.apellidos}</td>
                    <td>${participante.edad}</td>
                    <td>${participante.email}</td>
                    <td>${formacionesParticipante || 'Ninguna'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarParticipante('${participante.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="generarCarnet('${participante.id}')">
                            <i class="fas fa-id-card"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarParticipante('${participante.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== SECCIONES PARTICIPANTE =====
        function cargarSeccionParticipante(sectionId) {
            const participanteId = currentUser.entidadId;
            const participante = datosSistema.participantes.find(p => p.id === participanteId);

            if (!participante) {
                showAlert('Participante no encontrado', 'error');
                return;
            }

            switch(sectionId) {
                case 'dashboard-participante':
                    cargarEstadisticasParticipante(participanteId);
                    cargarInfoParticipante(participante);
                    break;
                case 'mi-perfil-participante':
                    cargarPerfilParticipante(participante);
                    break;
                case 'mis-formaciones':
                    cargarMisFormaciones(participanteId);
                    break;
                case 'inscribirse-formacion':
                    cargarFormacionesDisponibles(participante);
                    break;
            }
        }

        function cargarEstadisticasParticipante(participanteId) {
            const participante = datosSistema.participantes.find(p => p.id === participanteId);
            const misFormaciones = (participante?.formacionesIds || []).length;
            const formacionesDisponibles = datosSistema.formaciones.filter(f => 
                f.vacantes > 0 && 
                (!participante?.formacionesIds || !participante.formacionesIds.includes(f.id))
            ).length;

            document.getElementById('stat-mis-formaciones').textContent = misFormaciones;
            document.getElementById('stat-formaciones-disponibles').textContent = formacionesDisponibles;
        }

        function cargarInfoParticipante(participante) {
            const formacionesIds = participante.formacionesIds || [];
            const formaciones = formacionesIds.map(id => {
                const formacion = datosSistema.formaciones.find(f => f.id === id);
                return formacion ? formacion.nombre : '';
            }).filter(nombre => nombre).join(', ') || 'Ninguna';
            
            const plantel = datosSistema.planteles.find(p => p.id === participante.plantelId);
            const infoDiv = document.getElementById('info-participante-detalle');
            infoDiv.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cédula</label>
                        <input type="text" class="form-control" value="${participante.cedula}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nombres</label>
                        <input type="text" class="form-control" value="${participante.nombres}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Apellidos</label>
                        <input type="text" class="form-control" value="${participante.apellidos}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Edad</label>
                        <input type="number" class="form-control" value="${participante.edad}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" value="${participante.telefono}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" value="${participante.email}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Formaciones</label>
                        <input type="text" class="form-control" value="${formaciones}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Plantel</label>
                        <input type="text" class="form-control" value="${plantel ? plantel.nombre : 'No asignado'}" readonly>
                    </div>
                </div>
            `;
        }

        function cargarPerfilParticipante(participante) {
            const div = document.getElementById('perfil-participante-detalle');
            div.innerHTML = cargarInfoParticipante(participante).innerHTML;
        }

        function cargarMisFormaciones(participanteId) {
            const tbody = document.querySelector('#tabla-mis-formaciones tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const participante = datosSistema.participantes.find(p => p.id === participanteId);
            if (!participante || !participante.formacionesIds || participante.formacionesIds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No está inscrito en ninguna formación</td></tr>';
                return;
            }
            
            participante.formacionesIds.forEach(formacionId => {
                const formacion = datosSistema.formaciones.find(f => f.id === formacionId);
                if (!formacion) return;
                
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const plantel = datosSistema.planteles.find(p => p.id === formacion.plantelId);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td><span class="badge badge-success">Inscrito</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="darseDeBaja('${formacionId}', '${participanteId}')">
                            <i class="fas fa-sign-out-alt"></i> Darse de baja
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cargarFormacionesDisponibles(participante) {
            const tbody = document.querySelector('#tabla-formaciones-disponibles tbody');
            const selectPlantel = document.getElementById('filtro-plantel');
            
            if (!tbody || !selectPlantel) return;
            
            // Llenar select de planteles
            selectPlantel.innerHTML = '<option value="">Todos los planteles</option>';
            datosSistema.planteles.forEach(plantel => {
                const option = document.createElement('option');
                option.value = plantel.id;
                option.textContent = plantel.nombre;
                selectPlantel.appendChild(option);
            });
            
            tbody.innerHTML = '';
            
            const formacionesIdsInscritas = participante.formacionesIds || [];
            const formacionesDisponibles = datosSistema.formaciones.filter(f => 
                f.vacantes > 0 && 
                !formacionesIdsInscritas.includes(f.id)
            );
            
            if (formacionesDisponibles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay formaciones disponibles</td></tr>';
                return;
            }
            
            formacionesDisponibles.forEach(formacion => {
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const plantel = datosSistema.planteles.find(p => p.id === formacion.plantelId);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>${formacion.vacantes}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="inscribirseEnFormacion('${formacion.id}', '${participante.id}')">
                            <i class="fas fa-pen-alt"></i> Inscribirse
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filtrarFormacionesDisponibles() {
            const plantelId = document.getElementById('filtro-plantel').value;
            const participanteId = currentUser.entidadId;
            const participante = datosSistema.participantes.find(p => p.id === participanteId);
            
            if (!participante) return;
            
            const tbody = document.querySelector('#tabla-formaciones-disponibles tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const formacionesIdsInscritas = participante.formacionesIds || [];
            let formacionesDisponibles = datosSistema.formaciones.filter(f => 
                f.vacantes > 0 && 
                !formacionesIdsInscritas.includes(f.id)
            );
            
            if (plantelId) {
                formacionesDisponibles = formacionesDisponibles.filter(f => f.plantelId === plantelId);
            }
            
            if (formacionesDisponibles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay formaciones disponibles</td></tr>';
                return;
            }
            
            formacionesDisponibles.forEach(formacion => {
                const docente = datosSistema.docentes.find(d => d.id === formacion.docenteId);
                const plantel = datosSistema.planteles.find(p => p.id === formacion.plantelId);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formacion.id.substring(0, 8)}</td>
                    <td>${formacion.codigo}</td>
                    <td>${formacion.nombre}</td>
                    <td>${formacion.duracion} horas</td>
                    <td>${formacion.modalidad}</td>
                    <td>${docente ? `${docente.nombres} ${docente.apellidos}` : 'No asignado'}</td>
                    <td>${plantel ? plantel.nombre : 'No asignado'}</td>
                    <td>${formacion.vacantes}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="inscribirseEnFormacion('${formacion.id}', '${participanteId}')">
                            <i class="fas fa-pen-alt"></i> Inscribirse
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== CRUD COMPLETO =====
        // PLANTELES
        function guardarPlantel() {
            const plantel = {
                id: generarCodigoUnico(),
                codigoDependencia: document.getElementById('plantel-codigo-dependencia').value,
                codigoPlantel: document.getElementById('plantel-codigo-plantel').value,
                nombre: document.getElementById('plantel-nombre').value,
                direccion: document.getElementById('plantel-direccion').value,
                ciudad: document.getElementById('plantel-ciudad').value,
                telefono: document.getElementById('plantel-telefono').value,
                email: document.getElementById('plantel-email').value,
                estado: 'activo'
            };

            datosSistema.planteles.push(plantel);
            guardarDatos();
            closeModal('modal-plantel');
            cargarPlanteles();
            actualizarEstadisticas();
            showAlert('Plantel guardado exitosamente', 'success');
        }

        function editarPlantel(id) {
            const plantel = datosSistema.planteles.find(p => p.id === id);
            if (!plantel) return;

            editandoId = id;
            document.getElementById('editar-plantel-id').value = plantel.id;
            document.getElementById('editar-plantel-codigo-dependencia').value = plantel.codigoDependencia;
            document.getElementById('editar-plantel-codigo-plantel').value = plantel.codigoPlantel;
            document.getElementById('editar-plantel-nombre').value = plantel.nombre;
            document.getElementById('editar-plantel-direccion').value = plantel.direccion;
            document.getElementById('editar-plantel-ciudad').value = plantel.ciudad;
            document.getElementById('editar-plantel-telefono').value = plantel.telefono || '';
            document.getElementById('editar-plantel-email').value = plantel.email || '';

            openModal('modal-editar-plantel');
        }

        function actualizarPlantel() {
            const id = editandoId;
            const index = datosSistema.planteles.findIndex(p => p.id === id);
            if (index === -1) return;

            datosSistema.planteles[index] = {
                ...datosSistema.planteles[index],
                codigoDependencia: document.getElementById('editar-plantel-codigo-dependencia').value,
                codigoPlantel: document.getElementById('editar-plantel-codigo-plantel').value,
                nombre: document.getElementById('editar-plantel-nombre').value,
                direccion: document.getElementById('editar-plantel-direccion').value,
                ciudad: document.getElementById('editar-plantel-ciudad').value,
                telefono: document.getElementById('editar-plantel-telefono').value,
                email: document.getElementById('editar-plantel-email').value
            };

            guardarDatos();
            closeModal('modal-editar-plantel');
            cargarPlanteles();
            showAlert('Plantel actualizado exitosamente', 'success');
        }

        function eliminarPlantel(id) {
            if (!confirm('¿Está seguro de eliminar este plantel? Esto eliminará también los directores, docentes, participantes y formaciones asociadas.')) return;
            
            // Eliminar usuarios asociados al plantel
            datosSistema.usuarios = datosSistema.usuarios.filter(u => {
                if (u.rol === 'plantel' && u.entidadId === id) return false;
                if (u.rol === 'director') {
                    const director = datosSistema.directores.find(d => d.id === u.entidadId);
                    if (director && director.plantelId === id) return false;
                }
                if (u.rol === 'docente') {
                    const docente = datosSistema.docentes.find(d => d.id === u.entidadId);
                    if (docente && docente.plantelId === id) return false;
                }
                if (u.rol === 'participante') {
                    const participante = datosSistema.participantes.find(p => p.id === u.entidadId);
                    if (participante && participante.plantelId === id) return false;
                }
                return true;
            });
            
            // Eliminar directores asociados
            datosSistema.directores = datosSistema.directores.filter(d => d.plantelId !== id);
            
            // Eliminar docentes asociados
            datosSistema.docentes = datosSistema.docentes.filter(d => d.plantelId !== id);
            
            // Eliminar participantes asociados
            datosSistema.participantes = datosSistema.participantes.filter(p => p.plantelId !== id);
            
            // Eliminar formaciones asociadas
            datosSistema.formaciones = datosSistema.formaciones.filter(f => f.plantelId !== id);
            
            // Eliminar plantel
            datosSistema.planteles = datosSistema.planteles.filter(p => p.id !== id);
            
            guardarDatos();
            cargarPlanteles();
            actualizarEstadisticas();
            showAlert('Plantel y todos sus datos asociados eliminados exitosamente', 'success');
        }

        // DIRECTORES
        function guardarDirector() {
            const director = {
                id: generarCodigoUnico(),
                cedula: document.getElementById('director-cedula').value,
                nombres: document.getElementById('director-nombres').value,
                apellidos: document.getElementById('director-apellidos').value,
                telefono: document.getElementById('director-telefono').value,
                email: document.getElementById('director-email').value,
                plantelId: document.getElementById('director-plantel').value,
                estado: 'activo'
            };

            datosSistema.directores.push(director);
            
            // Actualizar plantel con el director
            const plantelIndex = datosSistema.planteles.findIndex(p => p.id === director.plantelId);
            if (plantelIndex !== -1) {
                // Si ya hay un director en este plantel, mostrar advertencia
                const directorExistente = datosSistema.directores.find(d => 
                    d.plantelId === director.plantelId && d.id !== director.id
                );
                if (directorExistente) {
                    if (!confirm('Este plantel ya tiene un director asignado. ¿Desea reemplazarlo?')) {
                        datosSistema.directores.pop(); // Eliminar el director recién agregado
                        guardarDatos();
                        return;
                    }
                }
            }
            
            guardarDatos();
            closeModal('modal-director');
            cargarDirectores();
            actualizarEstadisticas();
            showAlert('Director guardado exitosamente', 'success');
        }

        function editarDirector(id) {
            const director = datosSistema.directores.find(d => d.id === id);
            if (!director) return;

            editandoId = id;
            document.getElementById('editar-director-id').value = director.id;
            document.getElementById('editar-director-cedula').value = director.cedula;
            document.getElementById('editar-director-nombres').value = director.nombres;
            document.getElementById('editar-director-apellidos').value = director.apellidos;
            document.getElementById('editar-director-telefono').value = director.telefono;
            document.getElementById('editar-director-email').value = director.email;

            // Llenar select de planteles
            const select = document.getElementById('editar-director-plantel');
            select.innerHTML = '<option value="">Seleccione un plantel</option>';
            datosSistema.planteles.forEach(plantel => {
                const option = document.createElement('option');
                option.value = plantel.id;
                option.textContent = plantel.nombre;
                if (plantel.id === director.plantelId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            openModal('modal-editar-director');
        }

        function actualizarDirector() {
            const id = editandoId;
            const index = datosSistema.directores.findIndex(d => d.id === id);
            if (index === -1) return;

            const nuevoPlantelId = document.getElementById('editar-director-plantel').value;
            
            // Verificar si el nuevo plantel ya tiene un director
            if (nuevoPlantelId !== datosSistema.directores[index].plantelId) {
                const directorExistente = datosSistema.directores.find(d => 
                    d.plantelId === nuevoPlantelId && d.id !== id
                );
                if (directorExistente) {
                    if (!confirm('Este plantel ya tiene un director asignado. ¿Desea reemplazarlo?')) {
                        return;
                    }
                }
            }

            datosSistema.directores[index] = {
                ...datosSistema.directores[index],
                cedula: document.getElementById('editar-director-cedula').value,
                nombres: document.getElementById('editar-director-nombres').value,
                apellidos: document.getElementById('editar-director-apellidos').value,
                telefono: document.getElementById('editar-director-telefono').value,
                email: document.getElementById('editar-director-email').value,
                plantelId: nuevoPlantelId
            };

            guardarDatos();
            closeModal('modal-editar-director');
            cargarDirectores();
            showAlert('Director actualizado exitosamente', 'success');
        }

        function eliminarDirector(id) {
            if (!confirm('¿Está seguro de eliminar este director?')) return;
            
            datosSistema.directores = datosSistema.directores.filter(d => d.id !== id);
            
            // Eliminar usuario asociado
            datosSistema.usuarios = datosSistema.usuarios.filter(u => 
                !(u.rol === 'director' && u.entidadId === id)
            );
            
            guardarDatos();
            cargarDirectores();
            actualizarEstadisticas();
            showAlert('Director eliminado exitosamente', 'success');
        }

        // DOCENTES
        function guardarDocente() {
            const docente = {
                id: generarCodigoUnico(),
                cedula: document.getElementById('docente-cedula').value,
                nombres: document.getElementById('docente-nombres').value,
                apellidos: document.getElementById('docente-apellidos').value,
                especialidad: document.getElementById('docente-especialidad').value,
                telefono: document.getElementById('docente-telefono').value,
                email: document.getElementById('docente-email').value,
                plantelId: document.getElementById('docente-plantel').value,
                estado: 'activo'
            };

            datosSistema.docentes.push(docente);
            guardarDatos();
            closeModal('modal-docente');
            
            if (currentRole === 'admin') {
                cargarDocentes();
            } else if (currentRole === 'plantel') {
                cargarDocentesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarDocentesDirector(director.plantelId);
                }
            }
            
            actualizarEstadisticas();
            showAlert('Docente guardado exitosamente', 'success');
        }

        function editarDocente(id) {
            const docente = datosSistema.docentes.find(d => d.id === id);
            if (!docente) return;

            editandoId = id;
            document.getElementById('editar-docente-id').value = docente.id;
            document.getElementById('editar-docente-cedula').value = docente.cedula;
            document.getElementById('editar-docente-nombres').value = docente.nombres;
            document.getElementById('editar-docente-apellidos').value = docente.apellidos;
            document.getElementById('editar-docente-especialidad').value = docente.especialidad;
            document.getElementById('editar-docente-telefono').value = docente.telefono;
            document.getElementById('editar-docente-email').value = docente.email;

            // Llenar select de planteles
            const select = document.getElementById('editar-docente-plantel');
            select.innerHTML = '<option value="">Seleccione un plantel</option>';
            datosSistema.planteles.forEach(plantel => {
                const option = document.createElement('option');
                option.value = plantel.id;
                option.textContent = plantel.nombre;
                if (plantel.id === docente.plantelId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            openModal('modal-editar-docente');
        }

        function actualizarDocente() {
            const id = editandoId;
            const index = datosSistema.docentes.findIndex(d => d.id === id);
            if (index === -1) return;

            datosSistema.docentes[index] = {
                ...datosSistema.docentes[index],
                cedula: document.getElementById('editar-docente-cedula').value,
                nombres: document.getElementById('editar-docente-nombres').value,
                apellidos: document.getElementById('editar-docente-apellidos').value,
                especialidad: document.getElementById('editar-docente-especialidad').value,
                telefono: document.getElementById('editar-docente-telefono').value,
                email: document.getElementById('editar-docente-email').value,
                plantelId: document.getElementById('editar-docente-plantel').value
            };

            guardarDatos();
            closeModal('modal-editar-docente');
            
            if (currentRole === 'admin') {
                cargarDocentes();
            } else if (currentRole === 'plantel') {
                cargarDocentesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarDocentesDirector(director.plantelId);
                }
            }
            
            showAlert('Docente actualizado exitosamente', 'success');
        }

        function eliminarDocente(id) {
            if (!confirm('¿Está seguro de eliminar este docente?')) return;
            
            // Verificar si el docente tiene formaciones asignadas
            const formacionesDocente = datosSistema.formaciones.filter(f => f.docenteId === id);
            if (formacionesDocente.length > 0) {
                if (!confirm('Este docente tiene formaciones asignadas. ¿Desea eliminarlo de todas formas? Las formaciones quedarán sin docente asignado.')) {
                    return;
                }
            }
            
            datosSistema.docentes = datosSistema.docentes.filter(d => d.id !== id);
            
            // Eliminar usuario asociado
            datosSistema.usuarios = datosSistema.usuarios.filter(u => 
                !(u.rol === 'docente' && u.entidadId === id)
            );
            
            // Quitar docente de las formaciones
            datosSistema.formaciones.forEach(formacion => {
                if (formacion.docenteId === id) {
                    formacion.docenteId = null;
                }
            });
            
            guardarDatos();
            
            if (currentRole === 'admin') {
                cargarDocentes();
            } else if (currentRole === 'plantel') {
                cargarDocentesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarDocentesDirector(director.plantelId);
                }
            }
            
            actualizarEstadisticas();
            showAlert('Docente eliminado exitosamente', 'success');
        }

        // PARTICIPANTES
        function toggleDiscapacidad() {
            const discapacidad = document.getElementById('participante-discapacidad').value;
            const detalleDiv = document.getElementById('discapacidad-detalle');
            detalleDiv.style.display = discapacidad === 'si' ? 'block' : 'none';
        }

        function toggleDiscapacidadEditar() {
            const discapacidad = document.getElementById('editar-participante-discapacidad').value;
            const detalleDiv = document.getElementById('editar-discapacidad-detalle');
            detalleDiv.style.display = discapacidad === 'si' ? 'block' : 'none';
        }

        function cargarDocentesYFormaciones() {
            const plantelId = document.getElementById('participante-plantel').value;
            const selectDocente = document.getElementById('participante-docente');
            const selectFormacion = document.getElementById('participante-formacion');
            
            // Limpiar selects
            selectDocente.innerHTML = '<option value="">Seleccionar Docente</option>';
            selectFormacion.innerHTML = '<option value="">Seleccionar Formación</option>';
            
            if (!plantelId) return;
            
            // Cargar docentes del plantel
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const option = document.createElement('option');
                option.value = docente.id;
                option.textContent = `${docente.nombres} ${docente.apellidos}`;
                selectDocente.appendChild(option);
            });
            
            // Cargar formaciones del plantel
            const formaciones = datosSistema.formaciones.filter(f => f.plantelId === plantelId && f.vacantes > 0);
            formaciones.forEach(formacion => {
                const option = document.createElement('option');
                option.value = formacion.id;
                option.textContent = formacion.nombre;
                selectFormacion.appendChild(option);
            });
        }

        function cargarDocentesYFormacionesEditar() {
            const plantelId = document.getElementById('editar-participante-plantel').value;
            const selectDocente = document.getElementById('editar-participante-docente');
            const selectFormacion = document.getElementById('editar-participante-formacion');
            
            // Limpiar selects
            selectDocente.innerHTML = '<option value="">Seleccionar Docente</option>';
            selectFormacion.innerHTML = '<option value="">Seleccionar Formación</option>';
            
            if (!plantelId) return;
            
            // Cargar docentes del plantel
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const option = document.createElement('option');
                option.value = docente.id;
                option.textContent = `${docente.nombres} ${docente.apellidos}`;
                selectDocente.appendChild(option);
            });
        }

        function cargarFormacionesPorDocente() {
            const docenteId = document.getElementById('participante-docente').value;
            const selectFormacion = document.getElementById('participante-formacion');
            const plantelId = document.getElementById('participante-plantel').value;
            
            selectFormacion.innerHTML = '<option value="">Seleccionar Formación</option>';
            
            if (!docenteId || !plantelId) return;
            
            // Cargar formaciones del docente en el plantel
            const formaciones = datosSistema.formaciones.filter(f => 
                f.docenteId === docenteId && 
                f.plantelId === plantelId && 
                f.vacantes > 0
            );
            
            formaciones.forEach(formacion => {
                const option = document.createElement('option');
                option.value = formacion.id;
                option.textContent = formacion.nombre;
                selectFormacion.appendChild(option);
            });
        }

        function cargarFormacionesPorDocenteEditar() {
            const docenteId = document.getElementById('editar-participante-docente').value;
            const selectFormacion = document.getElementById('editar-participante-formacion');
            const plantelId = document.getElementById('editar-participante-plantel').value;
            
            selectFormacion.innerHTML = '<option value="">Seleccionar Formación</option>';
            
            if (!docenteId || !plantelId) return;
            
            // Cargar formaciones del docente en el plantel
            const formaciones = datosSistema.formaciones.filter(f => 
                f.docenteId === docenteId && 
                f.plantelId === plantelId && 
                f.vacantes > 0
            );
            
            formaciones.forEach(formacion => {
                const option = document.createElement('option');
                option.value = formacion.id;
                option.textContent = formacion.nombre;
                selectFormacion.appendChild(option);
            });
        }

        function guardarParticipante() {
            const participante = {
                id: generarCodigoUnico(),
                cedula: document.getElementById('participante-cedula').value,
                nombres: document.getElementById('participante-nombres').value,
                apellidos: document.getElementById('participante-apellidos').value,
                telefono: document.getElementById('participante-telefono').value,
                email: document.getElementById('participante-email').value,
                edad: parseInt(document.getElementById('participante-edad').value),
                sexo: document.getElementById('participante-sexo').value,
                fechaNacimiento: document.getElementById('participante-fecha-nacimiento').value,
                lugarNacimiento: document.getElementById('participante-lugar-nacimiento').value,
                parroquia: document.getElementById('participante-parroquia').value,
                direccion: document.getElementById('participante-direccion').value,
                discapacidad: document.getElementById('participante-discapacidad').value,
                discapacidadDetalle: document.getElementById('participante-discapacidad-detalle').value || '',
                tallaCamisa: document.getElementById('participante-talla-camisa').value,
                peso: document.getElementById('participante-peso').value,
                tallaPantalon: document.getElementById('participante-talla-pantalon').value,
                tallaZapato: document.getElementById('participante-talla-zapato').value,
                ocupacion: document.getElementById('participante-ocupacion').value,
                gradoInstruccion: document.getElementById('participante-grado-instruccion').value,
                plantelId: document.getElementById('participante-plantel').value,
                docenteId: document.getElementById('participante-docente').value,
                formacionesIds: [document.getElementById('participante-formacion').value],
                estado: 'activo'
            };

            datosSistema.participantes.push(participante);
            
            // Reducir vacantes de la formación
            const formacionId = document.getElementById('participante-formacion').value;
            const formacionIndex = datosSistema.formaciones.findIndex(f => f.id === formacionId);
            if (formacionIndex !== -1) {
                datosSistema.formaciones[formacionIndex].vacantes -= 1;
            }
            
            guardarDatos();
            closeModal('modal-participante');
            
            if (currentRole === 'admin') {
                cargarParticipantes();
            } else if (currentRole === 'plantel') {
                cargarParticipantesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarParticipantesDirector(director.plantelId);
                }
            } else if (currentRole === 'docente') {
                cargarParticipantesDocente(currentUser.entidadId);
            }
            
            actualizarEstadisticas();
            showAlert('Participante guardado exitosamente', 'success');
        }

        function editarParticipante(id) {
            const participante = datosSistema.participantes.find(p => p.id === id);
            if (!participante) return;

            editandoId = id;
            document.getElementById('editar-participante-id').value = participante.id;
            document.getElementById('editar-participante-cedula').value = participante.cedula;
            document.getElementById('editar-participante-nombres').value = participante.nombres;
            document.getElementById('editar-participante-apellidos').value = participante.apellidos;
            document.getElementById('editar-participante-telefono').value = participante.telefono;
            document.getElementById('editar-participante-email').value = participante.email;
            document.getElementById('editar-participante-edad').value = participante.edad;
            document.getElementById('editar-participante-sexo').value = participante.sexo;
            document.getElementById('editar-participante-fecha-nacimiento').value = participante.fechaNacimiento;
            document.getElementById('editar-participante-lugar-nacimiento').value = participante.lugarNacimiento;
            document.getElementById('editar-participante-parroquia').value = participante.parroquia;
            document.getElementById('editar-participante-direccion').value = participante.direccion;
            document.getElementById('editar-participante-discapacidad').value = participante.discapacidad;
            document.getElementById('editar-participante-discapacidad-detalle').value = participante.discapacidadDetalle || '';
            document.getElementById('editar-participante-talla-camisa').value = participante.tallaCamisa || '';
            document.getElementById('editar-participante-peso').value = participante.peso || '';
            document.getElementById('editar-participante-talla-pantalon').value = participante.tallaPantalon || '';
            document.getElementById('editar-participante-talla-zapato').value = participante.tallaZapato || '';
            document.getElementById('editar-participante-ocupacion').value = participante.ocupacion || '';
            document.getElementById('editar-participante-grado-instruccion').value = participante.gradoInstruccion;

            // Mostrar detalle de discapacidad si es necesario
            toggleDiscapacidadEditar();

            // Llenar selects
            const selectPlantel = document.getElementById('editar-participante-plantel');
            selectPlantel.innerHTML = '<option value="">Seleccionar Plantel</option>';
            datosSistema.planteles.forEach(plantel => {
                const option = document.createElement('option');
                option.value = plantel.id;
                option.textContent = plantel.nombre;
                if (plantel.id === participante.plantelId) {
                    option.selected = true;
                }
                selectPlantel.appendChild(option);
            });

            // Cargar docentes y formaciones después de un breve delay
            setTimeout(() => {
                cargarDocentesYFormacionesEditar();
                
                // Seleccionar docente si existe
                if (participante.docenteId) {
                    setTimeout(() => {
                        document.getElementById('editar-participante-docente').value = participante.docenteId;
                        cargarFormacionesPorDocenteEditar();
                        
                        // Seleccionar la primera formación si existe
                        if (participante.formacionesIds && participante.formacionesIds.length > 0) {
                            setTimeout(() => {
                                document.getElementById('editar-participante-formacion').value = participante.formacionesIds[0];
                            }, 100);
                        }
                    }, 100);
                }
            }, 100);

            openModal('modal-editar-participante');
        }

        function actualizarParticipante() {
            const id = editandoId;
            const index = datosSistema.participantes.findIndex(p => p.id === id);
            if (index === -1) return;

            // Obtener formación anterior
            const formacionAnteriorId = datosSistema.participantes[index].formacionesIds && 
                datosSistema.participantes[index].formacionesIds.length > 0 ? 
                datosSistema.participantes[index].formacionesIds[0] : null;
            
            const nuevaFormacionId = document.getElementById('editar-participante-formacion').value;

            // Actualizar vacantes si cambió la formación
            if (formacionAnteriorId !== nuevaFormacionId) {
                // Aumentar vacantes de la formación anterior
                if (formacionAnteriorId) {
                    const formacionAnteriorIndex = datosSistema.formaciones.findIndex(f => f.id === formacionAnteriorId);
                    if (formacionAnteriorIndex !== -1) {
                        datosSistema.formaciones[formacionAnteriorIndex].vacantes += 1;
                    }
                }
                
                // Reducir vacantes de la nueva formación
                if (nuevaFormacionId) {
                    const nuevaFormacionIndex = datosSistema.formaciones.findIndex(f => f.id === nuevaFormacionId);
                    if (nuevaFormacionIndex !== -1) {
                        datosSistema.formaciones[nuevaFormacionIndex].vacantes -= 1;
                    }
                }
            }

            datosSistema.participantes[index] = {
                ...datosSistema.participantes[index],
                cedula: document.getElementById('editar-participante-cedula').value,
                nombres: document.getElementById('editar-participante-nombres').value,
                apellidos: document.getElementById('editar-participante-apellidos').value,
                telefono: document.getElementById('editar-participante-telefono').value,
                email: document.getElementById('editar-participante-email').value,
                edad: parseInt(document.getElementById('editar-participante-edad').value),
                sexo: document.getElementById('editar-participante-sexo').value,
                fechaNacimiento: document.getElementById('editar-participante-fecha-nacimiento').value,
                lugarNacimiento: document.getElementById('editar-participante-lugar-nacimiento').value,
                parroquia: document.getElementById('editar-participante-parroquia').value,
                direccion: document.getElementById('editar-participante-direccion').value,
                discapacidad: document.getElementById('editar-participante-discapacidad').value,
                discapacidadDetalle: document.getElementById('editar-participante-discapacidad-detalle').value || '',
                tallaCamisa: document.getElementById('editar-participante-talla-camisa').value,
                peso: document.getElementById('editar-participante-peso').value,
                tallaPantalon: document.getElementById('editar-participante-talla-pantalon').value,
                tallaZapato: document.getElementById('editar-participante-talla-zapato').value,
                ocupacion: document.getElementById('editar-participante-ocupacion').value,
                gradoInstruccion: document.getElementById('editar-participante-grado-instruccion').value,
                plantelId: document.getElementById('editar-participante-plantel').value,
                docenteId: document.getElementById('editar-participante-docente').value,
                formacionesIds: [nuevaFormacionId]
            };

            guardarDatos();
            closeModal('modal-editar-participante');
            
            if (currentRole === 'admin') {
                cargarParticipantes();
            } else if (currentRole === 'plantel') {
                cargarParticipantesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarParticipantesDirector(director.plantelId);
                }
            } else if (currentRole === 'docente') {
                cargarParticipantesDocente(currentUser.entidadId);
            } else if (currentRole === 'participante') {
                cargarMisFormaciones(id);
                cargarFormacionesDisponibles(datosSistema.participantes[index]);
            }
            
            showAlert('Participante actualizado exitosamente', 'success');
        }

        function eliminarParticipante(id) {
            if (!confirm('¿Está seguro de eliminar este participante?')) return;
            
            const participante = datosSistema.participantes.find(p => p.id === id);
            if (!participante) return;
            
            // Aumentar vacantes de las formaciones en las que estaba inscrito
            if (participante.formacionesIds) {
                participante.formacionesIds.forEach(formacionId => {
                    const formacionIndex = datosSistema.formaciones.findIndex(f => f.id === formacionId);
                    if (formacionIndex !== -1) {
                        datosSistema.formaciones[formacionIndex].vacantes += 1;
                    }
                });
            }
            
            // Eliminar participante
            datosSistema.participantes = datosSistema.participantes.filter(p => p.id !== id);
            
            // Eliminar usuario asociado
            datosSistema.usuarios = datosSistema.usuarios.filter(u => 
                !(u.rol === 'participante' && u.entidadId === id)
            );
            
            guardarDatos();
            
            if (currentRole === 'admin') {
                cargarParticipantes();
            } else if (currentRole === 'plantel') {
                cargarParticipantesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarParticipantesDirector(director.plantelId);
                }
            } else if (currentRole === 'docente') {
                cargarParticipantesDocente(currentUser.entidadId);
            }
            
            actualizarEstadisticas();
            showAlert('Participante eliminado exitosamente', 'success');
        }

        // FORMACIONES
        function cargarDocentesPorPlantel() {
            const plantelId = document.getElementById('formacion-plantel').value;
            const selectDocente = document.getElementById('formacion-docente');
            
            selectDocente.innerHTML = '<option value="">Seleccionar Docente</option>';
            
            if (!plantelId) return;
            
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const option = document.createElement('option');
                option.value = docente.id;
                option.textContent = `${docente.nombres} ${docente.apellidos}`;
                selectDocente.appendChild(option);
            });
        }

        function cargarDocentesPorPlantelEditar() {
            const plantelId = document.getElementById('editar-formacion-plantel').value;
            const selectDocente = document.getElementById('editar-formacion-docente');
            
            selectDocente.innerHTML = '<option value="">Seleccionar Docente</option>';
            
            if (!plantelId) return;
            
            const docentes = datosSistema.docentes.filter(d => d.plantelId === plantelId);
            docentes.forEach(docente => {
                const option = document.createElement('option');
                option.value = docente.id;
                option.textContent = `${docente.nombres} ${docente.apellidos}`;
                selectDocente.appendChild(option);
            });
        }

        function guardarFormacion() {
            const formacion = {
                id: generarCodigoUnico(),
                codigo: document.getElementById('formacion-codigo').value,
                nombre: document.getElementById('formacion-nombre').value,
                descripcion: document.getElementById('formacion-descripcion').value,
                duracion: parseInt(document.getElementById('formacion-duracion').value),
                modalidad: document.getElementById('formacion-modalidad').value,
                docenteId: document.getElementById('formacion-docente').value,
                plantelId: document.getElementById('formacion-plantel').value,
                fechaInicio: document.getElementById('formacion-fecha-inicio').value,
                fechaFin: document.getElementById('formacion-fecha-fin').value,
                vacantes: parseInt(document.getElementById('formacion-vacantes').value),
                estado: 'activa'
            };

            datosSistema.formaciones.push(formacion);
            guardarDatos();
            closeModal('modal-formacion');
            
            if (currentRole === 'admin') {
                cargarFormaciones();
            } else if (currentRole === 'plantel') {
                cargarFormacionesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarFormacionesDirector(director.plantelId);
                }
            }
            
            actualizarEstadisticas();
            showAlert('Formación guardada exitosamente', 'success');
        }

        function editarFormacion(id) {
            const formacion = datosSistema.formaciones.find(f => f.id === id);
            if (!formacion) return;

            editandoId = id;
            document.getElementById('editar-formacion-id').value = formacion.id;
            document.getElementById('editar-formacion-codigo').value = formacion.codigo;
            document.getElementById('editar-formacion-nombre').value = formacion.nombre;
            document.getElementById('editar-formacion-descripcion').value = formacion.descripcion || '';
            document.getElementById('editar-formacion-duracion').value = formacion.duracion;
            document.getElementById('editar-formacion-modalidad').value = formacion.modalidad;
            document.getElementById('editar-formacion-fecha-inicio').value = formacion.fechaInicio;
            document.getElementById('editar-formacion-fecha-fin').value = formacion.fechaFin;
            document.getElementById('editar-formacion-vacantes').value = formacion.vacantes;

            // Llenar selects
            const selectPlantel = document.getElementById('editar-formacion-plantel');
            selectPlantel.innerHTML = '<option value="">Seleccionar Plantel</option>';
            datosSistema.planteles.forEach(plantel => {
                const option = document.createElement('option');
                option.value = plantel.id;
                option.textContent = plantel.nombre;
                if (plantel.id === formacion.plantelId) {
                    option.selected = true;
                }
                selectPlantel.appendChild(option);
            });

            // Cargar docentes después de un breve delay
            setTimeout(() => {
                cargarDocentesPorPlantelEditar();
                
                // Seleccionar docente si existe
                if (formacion.docenteId) {
                    setTimeout(() => {
                        document.getElementById('editar-formacion-docente').value = formacion.docenteId;
                    }, 100);
                }
            }, 100);

            openModal('modal-editar-formacion');
        }

        function actualizarFormacion() {
            const id = editandoId;
            const index = datosSistema.formaciones.findIndex(f => f.id === id);
            if (index === -1) return;

            datosSistema.formaciones[index] = {
                ...datosSistema.formaciones[index],
                codigo: document.getElementById('editar-formacion-codigo').value,
                nombre: document.getElementById('editar-formacion-nombre').value,
                descripcion: document.getElementById('editar-formacion-descripcion').value,
                duracion: parseInt(document.getElementById('editar-formacion-duracion').value),
                modalidad: document.getElementById('editar-formacion-modalidad').value,
                docenteId: document.getElementById('editar-formacion-docente').value,
                plantelId: document.getElementById('editar-formacion-plantel').value,
                fechaInicio: document.getElementById('editar-formacion-fecha-inicio').value,
                fechaFin: document.getElementById('editar-formacion-fecha-fin').value,
                vacantes: parseInt(document.getElementById('editar-formacion-vacantes').value)
            };

            guardarDatos();
            closeModal('modal-editar-formacion');
            
            if (currentRole === 'admin') {
                cargarFormaciones();
            } else if (currentRole === 'plantel') {
                cargarFormacionesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarFormacionesDirector(director.plantelId);
                }
            } else if (currentRole === 'docente') {
                cargarFormacionesDocente(currentUser.entidadId);
            }
            
            showAlert('Formación actualizada exitosamente', 'success');
        }

        function eliminarFormacion(id) {
            if (!confirm('¿Está seguro de eliminar esta formación?')) return;
            
            // Verificar si hay participantes inscritos
            const participantesInscritos = datosSistema.participantes.filter(p => 
                p.formacionesIds && p.formacionesIds.includes(id)
            );
            
            if (participantesInscritos.length > 0) {
                if (!confirm(`Hay ${participantesInscritos.length} participantes inscritos en esta formación. ¿Desea eliminarla de todas formas? Los participantes quedarán sin esta formación.`)) {
                    return;
                }
                
                // Quitar la formación de los participantes
                participantesInscritos.forEach(participante => {
                    participante.formacionesIds = participante.formacionesIds.filter(fid => fid !== id);
                });
            }
            
            datosSistema.formaciones = datosSistema.formaciones.filter(f => f.id !== id);
            guardarDatos();
            
            if (currentRole === 'admin') {
                cargarFormaciones();
            } else if (currentRole === 'plantel') {
                cargarFormacionesPlantel(currentUser.entidadId);
            } else if (currentRole === 'director') {
                const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                if (director) {
                    cargarFormacionesDirector(director.plantelId);
                }
            } else if (currentRole === 'docente') {
                cargarFormacionesDocente(currentUser.entidadId);
            }
            
            actualizarEstadisticas();
            showAlert('Formación eliminada exitosamente', 'success');
        }

        // USUARIOS
        function cargarEntidadesPorPlantel() {
            const plantelId = document.getElementById('usuario-plantel').value;
            const rol = document.getElementById('usuario-rol').value;
            const container = document.getElementById('usuario-entidad-container');
            const select = document.getElementById('usuario-entidad');
            
            if (!plantelId || !rol) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Configurar etiqueta según el rol
            let label = '';
            let entidades = [];
            
            switch(rol) {
                case 'plantel':
                    label = 'Plantel';
                    entidades = datosSistema.planteles.filter(p => p.id === plantelId);
                    break;
                case 'director':
                    label = 'Director';
                    entidades = datosSistema.directores.filter(d => d.plantelId === plantelId);
                    break;
                case 'docente':
                    label = 'Docente';
                    entidades = datosSistema.docentes.filter(d => d.plantelId === plantelId);
                    break;
                case 'participante':
                    label = 'Participante';
                    entidades = datosSistema.participantes.filter(p => p.plantelId === plantelId);
                    break;
            }
            
            document.getElementById('usuario-entidad-label').textContent = label;
            
            // Llenar select
            select.innerHTML = '<option value="">Seleccionar</option>';
            entidades.forEach(entidad => {
                const option = document.createElement('option');
                option.value = entidad.id;
                
                let texto = '';
                switch(rol) {
                    case 'plantel':
                        texto = entidad.nombre;
                        break;
                    case 'director':
                    case 'docente':
                    case 'participante':
                        texto = `${entidad.nombres} ${entidad.apellidos}`;
                        if (rol === 'participante') {
                            texto += ` - ${entidad.cedula}`;
                        }
                        break;
                }
                
                option.textContent = texto;
                select.appendChild(option);
            });
        }

        function actualizarUsuarioSegunRol() {
            const rol = document.getElementById('usuario-rol').value;
            const plantelId = document.getElementById('usuario-plantel').value;
            const usernameInput = document.getElementById('usuario-username');
            
            // Actualizar placeholder del usuario según el rol
            switch(rol) {
                case 'plantel':
                case 'director':
                case 'docente':
                    usernameInput.placeholder = 'Correo electrónico';
                    break;
                case 'participante':
                    usernameInput.placeholder = 'Cédula';
                    break;
            }
            
            // Si hay plantel seleccionado, cargar entidades
            if (plantelId) {
                cargarEntidadesPorPlantel();
            }
        }

        function guardarUsuario() {
            const plantelId = document.getElementById('usuario-plantel').value;
            const rol = document.getElementById('usuario-rol').value;
            const entidadId = document.getElementById('usuario-entidad').value;
            const username = document.getElementById('usuario-username').value;
            const password = document.getElementById('usuario-password').value;
            const confirmPassword = document.getElementById('usuario-confirm-password').value;
            const email = document.getElementById('usuario-email').value;

            if (!plantelId || !rol || !entidadId || !username || !password) {
                showAlert('Por favor, complete todos los campos obligatorios', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('Las contraseñas no coinciden', 'error');
                return;
            }

            // Verificar si el usuario ya existe
            const usuarioExistente = datosSistema.usuarios.find(u => 
                u.username === username || (email && u.email === email)
            );
            
            if (usuarioExistente) {
                showAlert('El usuario o email ya está registrado', 'error');
                return;
            }

            // Obtener información de la entidad
            let nombre = '';
            let emailEntidad = email;
            
            switch(rol) {
                case 'plantel':
                    const plantel = datosSistema.planteles.find(p => p.id === entidadId);
                    nombre = plantel ? plantel.nombre : 'Plantel';
                    if (!emailEntidad && plantel && plantel.email) {
                        emailEntidad = plantel.email;
                    }
                    break;
                case 'director':
                    const director = datosSistema.directores.find(d => d.id === entidadId);
                    nombre = director ? `${director.nombres} ${director.apellidos}` : 'Director';
                    if (!emailEntidad && director && director.email) {
                        emailEntidad = director.email;
                    }
                    break;
                case 'docente':
                    const docente = datosSistema.docentes.find(d => d.id === entidadId);
                    nombre = docente ? `${docente.nombres} ${docente.apellidos}` : 'Docente';
                    if (!emailEntidad && docente && docente.email) {
                        emailEntidad = docente.email;
                    }
                    break;
                case 'participante':
                    const participante = datosSistema.participantes.find(p => p.id === entidadId);
                    nombre = participante ? `${participante.nombres} ${participante.apellidos}` : 'Participante';
                    if (!emailEntidad && participante && participante.email) {
                        emailEntidad = participante.email;
                    }
                    break;
            }

            const usuario = {
                id: generarCodigoUnico(),
                username: username,
                password: password,
                email: emailEntidad,
                nombre: nombre,
                rol: rol,
                entidadId: entidadId,
                estado: 'activo',
                ultimoAcceso: null
            };

            datosSistema.usuarios.push(usuario);
            guardarDatos();
            closeModal('modal-usuario');
            cargarUsuarios();
            showAlert('Usuario creado exitosamente', 'success');
        }

        function editarUsuario(id) {
            const usuario = datosSistema.usuarios.find(u => u.id === id);
            if (!usuario) return;

            editandoId = id;
            document.getElementById('editar-usuario-id').value = usuario.id;
            document.getElementById('editar-usuario-username').value = usuario.username;
            document.getElementById('editar-usuario-email').value = usuario.email || '';
            document.getElementById('editar-usuario-estado').value = usuario.estado;

            openModal('modal-editar-usuario');
        }

        function actualizarUsuario() {
            const id = editandoId;
            const index = datosSistema.usuarios.findIndex(u => u.id === id);
            if (index === -1) return;

            const nuevaPassword = document.getElementById('editar-usuario-password').value;
            const confirmPassword = document.getElementById('editar-usuario-confirm-password').value;

            if (nuevaPassword && nuevaPassword !== confirmPassword) {
                showAlert('Las contraseñas no coinciden', 'error');
                return;
            }

            const usuarioActualizado = {
                ...datosSistema.usuarios[index],
                username: document.getElementById('editar-usuario-username').value,
                email: document.getElementById('editar-usuario-email').value,
                estado: document.getElementById('editar-usuario-estado').value
            };

            if (nuevaPassword) {
                usuarioActualizado.password = nuevaPassword;
            }

            datosSistema.usuarios[index] = usuarioActualizado;
            guardarDatos();
            closeModal('modal-editar-usuario');
            cargarUsuarios();
            showAlert('Usuario actualizado exitosamente', 'success');
        }

        function eliminarUsuario(id) {
            const usuario = datosSistema.usuarios.find(u => u.id === id);
            if (!usuario) return;
            
            if (usuario.rol === 'admin') {
                showAlert('No se puede eliminar un usuario administrador', 'error');
                return;
            }
            
            if (!confirm('¿Está seguro de eliminar este usuario?')) return;
            
            datosSistema.usuarios = datosSistema.usuarios.filter(u => u.id !== id);
            guardarDatos();
            cargarUsuarios();
            showAlert('Usuario eliminado exitosamente', 'success');
        }

        // ===== FUNCIONES DE INTERFACES =====
        function accederInterfaz(tipo) {
            // Buscar un usuario del tipo especificado
            const usuario = datosSistema.usuarios.find(u => 
                u.rol === tipo && u.estado === 'activo'
            );

            if (usuario) {
                // Guardar usuario actual
                const usuarioAdminActual = currentUser;
                const rolAdminActual = currentRole;
                
                // Ocultar admin dashboard
                document.getElementById('admin-dashboard').classList.add('hidden');
                
                // Mostrar dashboard del usuario
                currentUser = usuario;
                currentRole = tipo;
                mostrarDashboard(tipo, usuario);
                
                // Agregar botón de volver al admin
                const headerRight = document.querySelector(`#${tipo}-dashboard .header-right`);
                if (headerRight && !headerRight.querySelector('#volver-admin-btn')) {
                    const volverBtn = document.createElement('button');
                    volverBtn.id = 'volver-admin-btn';
                    volverBtn.className = 'btn btn-secondary';
                    volverBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Volver al Admin';
                    volverBtn.onclick = function() {
                        // Restaurar sesión de admin
                        currentUser = usuarioAdminActual;
                        currentRole = rolAdminActual;
                        
                        // Ocultar dashboard actual
                        document.getElementById(`${tipo}-dashboard`).classList.add('hidden');
                        
                        // Mostrar admin dashboard
                        document.getElementById('admin-dashboard').classList.remove('hidden');
                        
                        // Recargar datos del admin
                        actualizarEstadisticas();
                        cargarPlanteles();
                        cargarDirectores();
                        cargarDocentes();
                        cargarParticipantes();
                        cargarFormaciones();
                        cargarUsuarios();
                        
                        showAlert('Volviendo al panel de administración', 'info');
                    };
                    headerRight.insertBefore(volverBtn, headerRight.firstChild);
                }
                
                showAlert(`Accediendo como ${tipo}`, 'info');
            } else {
                showAlert(`No hay usuarios ${tipo} activos disponibles`, 'warning');
            }
        }

        function accederInterfazPlantel(plantelId) {
            const plantel = datosSistema.planteles.find(p => p.id === plantelId);
            if (!plantel) {
                showAlert('Plantel no encontrado', 'error');
                return;
            }

            const usuarioPlantel = datosSistema.usuarios.find(u => 
                u.rol === 'plantel' && u.entidadId === plantelId
            );

            if (!usuarioPlantel) {
                showAlert('No hay usuario asignado a este plantel', 'error');
                return;
            }

            // Guardar usuario actual
            const usuarioAdminActual = currentUser;
            const rolAdminActual = currentRole;
            
            // Ocultar admin dashboard
            document.getElementById('admin-dashboard').classList.add('hidden');
            
            // Mostrar dashboard del plantel
            currentUser = usuarioPlantel;
            currentRole = 'plantel';
            mostrarDashboard('plantel', usuarioPlantel);
            
            // Agregar botón de volver al admin
            const headerRight = document.querySelector('#plantel-dashboard .header-right');
            if (headerRight && !headerRight.querySelector('#volver-admin-btn')) {
                const volverBtn = document.createElement('button');
                volverBtn.id = 'volver-admin-btn';
                volverBtn.className = 'btn btn-secondary';
                volverBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Volver al Admin';
                volverBtn.onclick = function() {
                    // Restaurar sesión de admin
                    currentUser = usuarioAdminActual;
                    currentRole = rolAdminActual;
                    
                    // Ocultar dashboard actual
                    document.getElementById('plantel-dashboard').classList.add('hidden');
                    
                    // Mostrar admin dashboard
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    
                    // Recargar datos del admin
                    actualizarEstadisticas();
                    cargarPlanteles();
                    cargarDirectores();
                    cargarDocentes();
                    cargarParticipantes();
                    cargarFormaciones();
                    cargarUsuarios();
                    
                    showAlert('Volviendo al panel de administración', 'info');
                };
                headerRight.insertBefore(volverBtn, headerRight.firstChild);
            }
            
            showAlert(`Accediendo al plantel ${plantel.nombre}`, 'info');
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function showAlert(message, type = 'info', duration = 5000) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, duration);
        }

        function openModal(modalId) {
            // Llenar selects según el modal
            switch(modalId) {
                case 'modal-plantel':
                    // No necesita llenar selects
                    break;
                case 'modal-director':
                    const selectPlantelDirector = document.getElementById('director-plantel');
                    if (selectPlantelDirector) {
                        selectPlantelDirector.innerHTML = '<option value="">Seleccione un plantel</option>';
                        datosSistema.planteles.forEach(plantel => {
                            const option = document.createElement('option');
                            option.value = plantel.id;
                            option.textContent = plantel.nombre;
                            selectPlantelDirector.appendChild(option);
                        });
                    }
                    break;
                case 'modal-docente':
                    const selectPlantelDocente = document.getElementById('docente-plantel');
                    if (selectPlantelDocente) {
                        selectPlantelDocente.innerHTML = '<option value="">Seleccione un plantel</option>';
                        datosSistema.planteles.forEach(plantel => {
                            const option = document.createElement('option');
                            option.value = plantel.id;
                            option.textContent = plantel.nombre;
                            selectPlantelDocente.appendChild(option);
                        });
                    }
                    break;
                case 'modal-participante':
                    const selectPlantelParticipante = document.getElementById('participante-plantel');
                    if (selectPlantelParticipante) {
                        selectPlantelParticipante.innerHTML = '<option value="">Seleccionar Plantel</option>';
                        datosSistema.planteles.forEach(plantel => {
                            const option = document.createElement('option');
                            option.value = plantel.id;
                            option.textContent = plantel.nombre;
                            selectPlantelParticipante.appendChild(option);
                        });
                        
                        // Si estamos en una interfaz específica, seleccionar el plantel correspondiente
                        if (currentRole === 'plantel' && currentUser.entidadId) {
                            selectPlantelParticipante.value = currentUser.entidadId;
                            selectPlantelParticipante.disabled = true;
                            cargarDocentesYFormaciones();
                        } else if (currentRole === 'director') {
                            const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                            if (director && director.plantelId) {
                                selectPlantelParticipante.value = director.plantelId;
                                selectPlantelParticipante.disabled = true;
                                cargarDocentesYFormaciones();
                            }
                        } else if (currentRole === 'docente') {
                            const docente = datosSistema.docentes.find(d => d.id === currentUser.entidadId);
                            if (docente && docente.plantelId) {
                                selectPlantelParticipante.value = docente.plantelId;
                                selectPlantelParticipante.disabled = true;
                                cargarDocentesYFormaciones();
                            }
                        }
                    }
                    break;
                case 'modal-formacion':
                    const selectPlantelFormacion = document.getElementById('formacion-plantel');
                    if (selectPlantelFormacion) {
                        selectPlantelFormacion.innerHTML = '<option value="">Seleccionar Plantel</option>';
                        datosSistema.planteles.forEach(plantel => {
                            const option = document.createElement('option');
                            option.value = plantel.id;
                            option.textContent = plantel.nombre;
                            selectPlantelFormacion.appendChild(option);
                        });
                        
                        // Si estamos en una interfaz específica, seleccionar el plantel correspondiente
                        if (currentRole === 'plantel' && currentUser.entidadId) {
                            selectPlantelFormacion.value = currentUser.entidadId;
                            selectPlantelFormacion.disabled = true;
                            cargarDocentesPorPlantel();
                        } else if (currentRole === 'director') {
                            const director = datosSistema.directores.find(d => d.id === currentUser.entidadId);
                            if (director && director.plantelId) {
                                selectPlantelFormacion.value = director.plantelId;
                                selectPlantelFormacion.disabled = true;
                                cargarDocentesPorPlantel();
                            }
                        }
                    }
                    break;
                case 'modal-usuario':
                    const selectPlantelUsuario = document.getElementById('usuario-plantel');
                    if (selectPlantelUsuario) {
                        selectPlantelUsuario.innerHTML = '<option value="">Seleccionar Plantel</option>';
                        datosSistema.planteles.forEach(plantel => {
                            const option = document.createElement('option');
                            option.value = plantel.id;
                            option.textContent = plantel.nombre;
                            selectPlantelUsuario.appendChild(option);
                        });
                    }
                    break;
            }
            
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Limpiar formularios
            if (modalId.includes('modal-')) {
                const form = document.querySelector(`#${modalId} form`);
                if (form) form.reset();
                
                // Habilitar selects deshabilitados
                const disabledSelects = form.querySelectorAll('select[disabled]');
                disabledSelects.forEach(select => {
                    select.disabled = false;
                });
            }
            editandoId = null;
        }

        function actualizarEstadisticas() {
            document.getElementById('stat-planteles').textContent = datosSistema.planteles.length;
            document.getElementById('stat-participantes').textContent = datosSistema.participantes.length;
            document.getElementById('stat-docentes').textContent = datosSistema.docentes.length;
            document.getElementById('stat-formaciones').textContent = datosSistema.formaciones.length;
        }

        function iniciarSincronizacionAutomatica() {
            if (intervaloSincronizacion) {
                clearInterval(intervaloSincronizacion);
            }

            const intervalo = datosSistema.configuracion.intervaloSincronizacion * 1000;
            intervaloSincronizacion = setInterval(() => {
                sincronizarDatos();
                actualizarInterfazActual();
            }, intervalo);
        }

        function actualizarInterfazActual() {
            if (currentRole === 'admin') {
                const activeSection = document.querySelector('.content-section:not(.hidden)');
                if (activeSection) {
                    const sectionId = activeSection.id.replace('section-', '');
                    cargarSeccionAdmin(sectionId);
                }
            } else if (currentRole === 'plantel') {
                const activeSection = document.querySelector('.content-section:not(.hidden)');
                if (activeSection) {
                    const sectionId = activeSection.id.replace('section-', '');
                    cargarSeccionPlantel(sectionId);
                }
            } else if (currentRole === 'director') {
                const activeSection = document.querySelector('.content-section:not(.hidden)');
                if (activeSection) {
                    const sectionId = activeSection.id.replace('section-', '');
                    cargarSeccionDirector(sectionId);
                }
            } else if (currentRole === 'docente') {
                const activeSection = document.querySelector('.content-section:not(.hidden)');
                if (activeSection) {
                    const sectionId = activeSection.id.replace('section-', '');
                    cargarSeccionDocente(sectionId);
                }
            } else if (currentRole === 'participante') {
                const activeSection = document.querySelector('.content-section:not(.hidden)');
                if (activeSection) {
                    const sectionId = activeSection.id.replace('section-', '');
                    cargarSeccionParticipante(sectionId);
                }
            }
        }

        function logout() {
            // Limpiar usuario actual
            currentUser = null;
            currentRole = null;

            // Detener intervalo de sincronización
            if (intervaloSincronizacion) {
                clearInterval(intervaloSincronizacion);
                intervaloSincronizacion = null;
            }

            // Ocultar todos los dashboards
            document.querySelectorAll('.dashboard-container').forEach(dash => {
                dash.classList.add('hidden');
            });

            // Mostrar login
            document.getElementById('login-container').classList.remove('hidden');

            // Limpiar formulario de login
            document.getElementById('login-form').reset();

            showAlert('Sesión cerrada exitosamente', 'success');
        }

        function configurarModoConexion() {
            const statusElement = document.getElementById('connection-status');
            if (modoConexion === 'online') {
                statusElement.className = 'connection-status connection-online';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Modo Online</span>';
            } else {
                statusElement.className = 'connection-status connection-offline';
                statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Modo Offline</span>';
            }
        }

        function sincronizarDatos() {
            if (modoConexion === 'offline') {
                return;
            }

            // Simular sincronización
            guardarDatos();
        }

        function repararSistema() {
            if (confirm('¿Está seguro de reparar el sistema? Esto verificará y corregirá posibles problemas en los datos.')) {
                showAlert('Reparando sistema...', 'info');
                
                // Verificar y reparar datos
                datosSistema.planteles = datosSistema.planteles || [];
                datosSistema.directores = datosSistema.directores || [];
                datosSistema.docentes = datosSistema.docentes || [];
                datosSistema.participantes = datosSistema.participantes || [];
                datosSistema.formaciones = datosSistema.formaciones || [];
                datosSistema.usuarios = datosSistema.usuarios || [];
                datosSistema.configuracion = datosSistema.configuracion || {
                    intervaloSincronizacion: 5,
                    frecuenciaBackup: 'diario',
                    modoConexion: 'online',
                    tema: 'theme-1'
                };

                // Asegurar que exista el usuario admin
                if (!datosSistema.usuarios.find(u => u.id === currentUser?.id)) {
                    datosSistema.usuarios.unshift({
                        id: generarCodigoUnico(),
                        username: 'pabloemiliorico24@gmail.com',
                        password: 'Perp.241',
                        email: 'pabloemiliorico24@gmail.com',
                        nombre: 'Administrador Principal',
                        rol: 'admin',
                        entidadId: null,
                        estado: 'activo',
                        ultimoAcceso: null
                    });
                }

                // Verificar consistencia de datos
                datosSistema.directores = datosSistema.directores.filter(director => 
                    datosSistema.planteles.some(plantel => plantel.id === director.plantelId)
                );
                
                datosSistema.docentes = datosSistema.docentes.filter(docente => 
                    datosSistema.planteles.some(plantel => plantel.id === docente.plantelId)
                );
                
                datosSistema.participantes = datosSistema.participantes.filter(participante => 
                    datosSistema.planteles.some(plantel => plantel.id === participante.plantelId)
                );
                
                datosSistema.formaciones = datosSistema.formaciones.filter(formacion => 
                    datosSistema.planteles.some(plantel => plantel.id === formacion.plantelId)
                );
                
                datosSistema.usuarios = datosSistema.usuarios.filter(usuario => {
                    if (usuario.rol === 'plantel') {
                        return datosSistema.planteles.some(plantel => plantel.id === usuario.entidadId);
                    }
                    if (usuario.rol === 'director') {
                        return datosSistema.directores.some(director => director.id === usuario.entidadId);
                    }
                    if (usuario.rol === 'docente') {
                        return datosSistema.docentes.some(docente => docente.id === usuario.entidadId);
                    }
                    if (usuario.rol === 'participante') {
                        return datosSistema.participantes.some(participante => participante.id === usuario.entidadId);
                    }
                    return true; // admin
                });

                guardarDatos();
                showAlert('Sistema reparado exitosamente', 'success');
                
                // Recargar la interfaz actual
                if (currentRole === 'admin') {
                    const activeSection = document.querySelector('.content-section:not(.hidden)');
                    if (activeSection) {
                        const sectionId = activeSection.id.replace('section-', '');
                        cargarSeccionAdmin(sectionId);
                    }
                }
            }
        }

        function cargarPerfilAdmin() {
            const usuario = datosSistema.usuarios.find(u => u.id === currentUser.id);
            if (!usuario) return;

            document.getElementById('admin-profile-name').value = usuario.nombre;
            document.getElementById('admin-profile-email').value = usuario.email || '';
        }

        function guardarPerfilAdmin() {
            const usuario = datosSistema.usuarios.find(u => u.id === currentUser.id);
            if (!usuario) return;

            const currentPassword = document.getElementById('admin-current-password').value;
            const newPassword = document.getElementById('admin-new-password').value;
            const confirmPassword = document.getElementById('admin-confirm-password').value;

            if (currentPassword && usuario.password !== currentPassword) {
                showAlert('Contraseña actual incorrecta', 'error');
                return;
            }

            if (newPassword && newPassword !== confirmPassword) {
                showAlert('Las contraseñas nuevas no coinciden', 'error');
                return;
            }

            usuario.nombre = document.getElementById('admin-profile-name').value;
            usuario.email = document.getElementById('admin-profile-email').value;
            
            if (newPassword) {
                usuario.password = newPassword;
            }

            guardarDatos();
            document.getElementById('admin-name').textContent = usuario.nombre;
            showAlert('Perfil actualizado exitosamente', 'success');
            
            // Limpiar campos de contraseña
            document.getElementById('admin-current-password').value = '';
            document.getElementById('admin-new-password').value = '';
            document.getElementById('admin-confirm-password').value = '';
        }

        function guardarConfiguracion() {
            datosSistema.configuracion.intervaloSincronizacion = 
                parseInt(document.getElementById('intervalo-sincronizacion').value) || 5;
            datosSistema.configuracion.frecuenciaBackup = 
                document.getElementById('frecuencia-backup').value || 'diario';
            
            guardarDatos();
            iniciarSincronizacionAutomatica();
            showAlert('Configuración guardada exitosamente', 'success');
        }

        function crearBackup() {
            const fecha = new Date().toISOString().replace(/[:.]/g, '-');
            const nombreArchivo = `backup_complejo_virtual_epe_${fecha}.json`;
            const datos = JSON.stringify(datosSistema, null, 2);
            
            const blob = new Blob([datos], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Guardar referencia al último backup
            ultimoBackup = nombreArchivo;
            localStorage.setItem('ultimoBackup', nombreArchivo);
            
            showAlert('Backup creado exitosamente', 'success');
        }

        function crearBackupAutomatico() {
            // Solo crear backup automático si ha pasado un día desde el último
            const ultimoBackupFecha = localStorage.getItem('ultimoBackupFecha');
            const hoy = new Date().toDateString();
            
            if (!ultimoBackupFecha || ultimoBackupFecha !== hoy) {
                const datos = JSON.stringify(datosSistema);
                localStorage.setItem('backup_automatico_' + new Date().toISOString().split('T')[0], datos);
                localStorage.setItem('ultimoBackupFecha', hoy);
            }
        }

        function cargarBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const datos = JSON.parse(e.target.result);
                        
                        if (!datos.planteles || !datos.usuarios) {
                            showAlert('El archivo no es un backup válido', 'error');
                            return;
                        }
                        
                        if (confirm('¿Está seguro de cargar este backup? Se reemplazarán todos los datos actuales.')) {
                            datosSistema = datos;
                            guardarDatos();
                            location.reload();
                        }
                    } catch (error) {
                        showAlert('Error al leer el archivo de backup', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function cargarVersionAnterior() {
            // Buscar backups automáticos
            const backups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('backup_automatico_')) {
                    backups.push({
                        key: key,
                        fecha: key.replace('backup_automatico_', '')
                    });
                }
            }
            
            if (backups.length === 0) {
                showAlert('No hay versiones anteriores disponibles', 'warning');
                return;
            }
            
            // Ordenar por fecha (más reciente primero)
            backups.sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            const ultimoBackup = backups[0];
            if (confirm(`¿Cargar versión del ${ultimoBackup.fecha}?`)) {
                const datos = JSON.parse(localStorage.getItem(ultimoBackup.key));
                datosSistema = datos;
                guardarDatos();
                location.reload();
            }
        }

        function inscribirseEnFormacion(formacionId, participanteId) {
            const participanteIndex = datosSistema.participantes.findIndex(p => p.id === participanteId);
            if (participanteIndex === -1) return;

            const formacion = datosSistema.formaciones.find(f => f.id === formacionId);
            if (!formacion || formacion.vacantes <= 0) {
                showAlert('No hay vacantes disponibles en esta formación', 'error');
                return;
            }

            // Verificar que no esté ya inscrito
            const formacionesIds = datosSistema.participantes[participanteIndex].formacionesIds || [];
            if (formacionesIds.includes(formacionId)) {
                showAlert('Ya está inscrito en esta formación', 'warning');
                return;
            }

            // Agregar formación
            formacionesIds.push(formacionId);
            datosSistema.participantes[participanteIndex].formacionesIds = formacionesIds;

            // Reducir vacantes
            const formacionIndex = datosSistema.formaciones.findIndex(f => f.id === formacionId);
            datosSistema.formaciones[formacionIndex].vacantes -= 1;

            guardarDatos();
            showAlert('Inscripción realizada exitosamente', 'success');
            
            // Actualizar interfaces
            if (currentRole === 'participante') {
                cargarSeccionParticipante('mis-formaciones');
                cargarSeccionParticipante('inscribirse-formacion');
            }
        }

        function darseDeBaja(formacionId, participanteId) {
            if (!confirm('¿Está seguro de darse de baja de esta formación?')) return;

            const participanteIndex = datosSistema.participantes.findIndex(p => p.id === participanteId);
            if (participanteIndex === -1) return;

            const formacionesIds = datosSistema.participantes[participanteIndex].formacionesIds || [];
            const nuevaFormacionesIds = formacionesIds.filter(id => id !== formacionId);
            
            if (formacionesIds.length === nuevaFormacionesIds.length) {
                showAlert('No está inscrito en esta formación', 'warning');
                return;
            }

            datosSistema.participantes[participanteIndex].formacionesIds = nuevaFormacionesIds;

            // Aumentar vacantes
            const formacionIndex = datosSistema.formaciones.findIndex(f => f.id === formacionId);
            if (formacionIndex !== -1) {
                datosSistema.formaciones[formacionIndex].vacantes += 1;
            }

            guardarDatos();
            showAlert('Se ha dado de baja exitosamente', 'success');
            
            // Actualizar interfaces
            if (currentRole === 'participante') {
                cargarSeccionParticipante('mis-formaciones');
                cargarSeccionParticipante('inscribirse-formacion');
            }
        }

        function actualizarDesdeGitHub() {
            showAlert('Buscando actualizaciones en GitHub...', 'info');
            // Simular actualización
            setTimeout(() => {
                showAlert('Sistema actualizado correctamente desde GitHub', 'success');
            }, 2000);
        }

        function generarCarnet(participanteId) {
            const participante = datosSistema.participantes.find(p => p.id === participanteId);
            if (!participante) {
                showAlert('Participante no encontrado', 'error');
                return;
            }

            const plantel = datosSistema.planteles.find(p => p.id === participante.plantelId);
            const formacionesIds = participante.formacionesIds || [];
            const formaciones = formacionesIds.map(id => {
                const formacion = datosSistema.formaciones.find(f => f.id === id);
                return formacion ? formacion.nombre : '';
            }).filter(nombre => nombre).join(', ') || 'Ninguna';

            // Crear contenido del carné
            const carnetContainer = document.getElementById('carnet-container');
            carnetContainer.innerHTML = '';
            carnetContainer.style.display = 'block';

            const carnet = document.createElement('div');
            carnet.className = 'carnet';
            carnet.innerHTML = `
                <div class="carnet-header">
                    <h4 style="margin: 0; font-size: 0.9rem;">COMPLEJO VIRTUAL EPE</h4>
                    <p style="margin: 2px 0; font-size: 0.7rem;">Sistema CRM Educativo</p>
                </div>
                <div class="carnet-photo">
                    <i class="fas fa-user" style="font-size: 2rem; color: #666;"></i>
                </div>
                <div class="carnet-info">
                    <p><strong>Nombre:</strong> ${participante.nombres} ${participante.apellidos}</p>
                    <p><strong>Cédula:</strong> ${participante.cedula}</p>
                    <p><strong>Plantel:</strong> ${plantel ? plantel.nombre : 'No asignado'}</p>
                    <p><strong>Formaciones:</strong> ${formaciones}</p>
                    <p><strong>Estado:</strong> Activo</p>
                    <p><strong>Válido hasta:</strong> ${new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString()}</p>
                </div>
                <div class="carnet-qr" id="qr-code"></div>
            `;

            carnetContainer.appendChild(carnet);

            // Generar QR
            const qrData = JSON.stringify({
                id: participante.id,
                nombre: `${participante.nombres} ${participante.apellidos}`,
                cedula: participante.cedula,
                plantel: plantel ? plantel.nombre : '',
                fecha: new Date().toISOString()
            });

            QRCode.toCanvas(document.getElementById('qr-code'), qrData, {
                width: 60,
                height: 60,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) console.error(error);
            });

            // Mostrar modal para descargar
            setTimeout(() => {
                if (confirm('¿Desea descargar el carné?')) {
                    descargarCarnet(participante);
                }
                carnetContainer.style.display = 'none';
            }, 100);
        }

        function descargarCarnet(participante) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'cm',
                format: [5.4, 8.6]
            });

            const plantel = datosSistema.planteles.find(p => p.id === participante.plantelId);
            const formacionesIds = participante.formacionesIds || [];
            const formaciones = formacionesIds.map(id => {
                const formacion = datosSistema.formaciones.find(f => f.id === id);
                return formacion ? formacion.nombre : '';
            }).filter(nombre => nombre).join(', ') || 'Ninguna';

            // Fondo y marco
            doc.setFillColor(240, 240, 240);
            doc.rect(0.2, 0.2, 5, 8.2, 'F');
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.05);
            doc.rect(0.2, 0.2, 5, 8.2);

            // Encabezado
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('COMPLEJO VIRTUAL EPE', 2.7, 1, { align: 'center' });
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema CRM Educativo', 2.7, 1.4, { align: 'center' });

            // Línea separadora
            doc.setLineWidth(0.05);
            doc.line(0.5, 1.6, 4.9, 1.6);

            // Foto (placeholder)
            doc.setFillColor(200, 200, 200);
            doc.rect(2.2, 2, 1, 1.5, 'F');
            doc.setFontSize(6);
            doc.text('FOTO', 2.7, 2.8, { align: 'center' });

            // Información
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.text('Nombre:', 0.5, 4);
            doc.text('Cédula:', 0.5, 4.5);
            doc.text('Plantel:', 0.5, 5);
            doc.text('Formaciones:', 0.5, 5.5);
            doc.text('Estado:', 0.5, 6);
            doc.text('Válido hasta:', 0.5, 6.5);

            doc.setFont('helvetica', 'normal');
            doc.text(`${participante.nombres} ${participante.apellidos}`, 2, 4);
            doc.text(participante.cedula, 2, 4.5);
            doc.text(plantel ? plantel.nombre.substring(0, 20) : 'No asignado', 2, 5);
            doc.text(formaciones.substring(0, 25), 2, 5.5);
            doc.text('Activo', 2, 6);
            doc.text(new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString(), 2, 6.5);

            // Pie de página
            doc.setFontSize(6);
            doc.text('© 2024 Complejo Virtual EPE', 2.7, 8, { align: 'center' });

            // Guardar PDF
            doc.save(`carnet_${participante.cedula}.pdf`);
            showAlert('Carné descargado exitosamente', 'success');
        }

        function generarReportePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('Reporte del Sistema - Complejo Virtual EPE', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            let y = 40;
            
            // Estadísticas
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Estadísticas Generales', 20, y);
            y += 10;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`• Planteles: ${datosSistema.planteles.length}`, 20, y);
            y += 7;
            doc.text(`• Directores: ${datosSistema.directores.length}`, 20, y);
            y += 7;
            doc.text(`• Docentes: ${datosSistema.docentes.length}`, 20, y);
            y += 7;
            doc.text(`• Participantes: ${datosSistema.participantes.length}`, 20, y);
            y += 7;
            doc.text(`• Formaciones: ${datosSistema.formaciones.length}`, 20, y);
            y += 7;
            doc.text(`• Usuarios: ${datosSistema.usuarios.length}`, 20, y);
            y += 15;
            
            // Planteles
            if (datosSistema.planteles.length > 0) {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Planteles Registrados', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                datosSistema.planteles.forEach((plantel, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${index + 1}. ${plantel.nombre} (${plantel.codigoDependencia}-${plantel.codigoPlantel}) - ${plantel.ciudad}`, 25, y);
                    y += 7;
                });
                y += 10;
            }
            
            // Guardar PDF
            doc.save(`reporte_complejo_virtual_epe_${new Date().toISOString().split('T')[0]}.pdf`);
            showAlert('Reporte PDF generado exitosamente', 'success');
        }

        function generarReporteExcel() {
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            
            // Hoja de estadísticas
            const estadisticasData = [
                ['ESTADÍSTICAS DEL SISTEMA', ''],
                ['Fecha', new Date().toLocaleDateString()],
                [''],
                ['Concepto', 'Cantidad'],
                ['Planteles', datosSistema.planteles.length],
                ['Directores', datosSistema.directores.length],
                ['Docentes', datosSistema.docentes.length],
                ['Participantes', datosSistema.participantes.length],
                ['Formaciones', datosSistema.formaciones.length],
                ['Usuarios', datosSistema.usuarios.length]
            ];
            
            const wsEstadisticas = XLSX.utils.aoa_to_sheet(estadisticasData);
            XLSX.utils.book_append_sheet(wb, wsEstadisticas, 'Estadísticas');
            
            // Hoja de planteles
            if (datosSistema.planteles.length > 0) {
                const plantelesData = [
                    ['ID', 'Código Dependencia', 'Código Plantel', 'Nombre', 'Dirección', 'Ciudad', 'Teléfono', 'Email', 'Estado']
                ];
                
                datosSistema.planteles.forEach(plantel => {
                    plantelesData.push([
                        plantel.id.substring(0, 8),
                        plantel.codigoDependencia,
                        plantel.codigoPlantel,
                        plantel.nombre,
                        plantel.direccion,
                        plantel.ciudad,
                        plantel.telefono || '',
                        plantel.email || '',
                        plantel.estado
                    ]);
                });
                
                const wsPlanteles = XLSX.utils.aoa_to_sheet(plantelesData);
                XLSX.utils.book_append_sheet(wb, wsPlanteles, 'Planteles');
            }
            
            // Hoja de participantes
            if (datosSistema.participantes.length > 0) {
                const participantesData = [
                    ['ID', 'Cédula', 'Nombres', 'Apellidos', 'Edad', 'Sexo', 'Email', 'Teléfono', 'Plantel', 'Formaciones', 'Estado']
                ];
                
                datosSistema.participantes.forEach(participante => {
                    const plantel = datosSistema.planteles.find(p => p.id === participante.plantelId);
                    const formacionesIds = participante.formacionesIds || [];
                    const formacionesNombres = formacionesIds.map(id => {
                        const formacion = datosSistema.formaciones.find(f => f.id === id);
                        return formacion ? formacion.nombre : '';
                    }).filter(nombre => nombre).join(', ') || 'Ninguna';
                    
                    participantesData.push([
                        participante.id.substring(0, 8),
                        participante.cedula,
                        participante.nombres,
                        participante.apellidos,
                        participante.edad,
                        participante.sexo,
                        participante.email,
                        participante.telefono,
                        plantel ? plantel.nombre : '',
                        formacionesNombres,
                        participante.estado
                    ]);
                });
                
                const wsParticipantes = XLSX.utils.aoa_to_sheet(participantesData);
                XLSX.utils.book_append_sheet(wb, wsParticipantes, 'Participantes');
            }
            
            // Guardar archivo
            XLSX.writeFile(wb, `reporte_complejo_virtual_epe_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert('Reporte Excel generado exitosamente', 'success');
        }
    </script>
</body>
</html>